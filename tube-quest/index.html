<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üöá Tube Quest: Commuter Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
:root {
  --tfl-red: #E11B22;
  --tfl-navy: #0019A8;
  --tfl-blue: #00A3E0;
  --elizabeth: #603A9E;
  --oyster-teal: #00B2A9;
  --bg: #0A0E1A;
  --surface: #131929;
  --surface2: #1E2A40;
  --card-bg: #1A2035;
  --text: #F0F4FF;
  --text-dim: #8899BB;
  --gold: #FFD700;
  --green: #00C851;
  --warn: #FF6B35;
  --font-h: 'Bebas Neue', sans-serif;
  --font-b: 'Nunito', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font-b);}
#app{width:100vw;height:100vh;display:flex;flex-direction:column;overflow:hidden;position:relative;}

/* HEADER */
#header{
  background:linear-gradient(135deg,#0A0E1A 0%,#131929 100%);
  border-bottom:3px solid var(--tfl-red);
  padding:8px 12px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;z-index:10;
}
#header h1{font-family:var(--font-h);font-size:clamp(22px,5vw,36px);letter-spacing:2px;
  background:linear-gradient(90deg,var(--tfl-red),var(--oyster-teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#oyster-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.oyster-chip{background:var(--oyster-teal);color:#000;border-radius:20px;padding:4px 12px;
  font-size:clamp(14px,3vw,20px);font-weight:900;}
.streak-chip{background:var(--warn);color:#fff;border-radius:20px;padding:4px 10px;
  font-size:clamp(12px,2.5vw,18px);font-weight:900;}
#btn-fullscreen,#btn-mute,#btn-slow{
  background:var(--surface2);border:2px solid var(--text-dim);color:var(--text);
  border-radius:10px;padding:6px 10px;font-size:20px;cursor:pointer;transition:all 0.2s;}
#btn-fullscreen:hover,#btn-mute:hover,#btn-slow:hover{border-color:var(--oyster-teal);transform:scale(1.1);}

/* MAIN */
#main{flex:1;display:flex;overflow:hidden;position:relative;}

/* LEFT PANEL */
#left-panel{
  width:clamp(270px,33vw,400px);
  background:var(--surface);
  border-right:2px solid var(--surface2);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;
}
#tabs{display:flex;border-bottom:2px solid var(--surface2);}
.tab{flex:1;padding:10px 4px;text-align:center;font-family:var(--font-h);
  font-size:clamp(12px,2.2vw,18px);letter-spacing:1px;cursor:pointer;
  transition:all 0.2s;border-bottom:3px solid transparent;
  background:none;border-top:none;border-left:none;border-right:none;color:var(--text-dim);}
.tab.active{color:var(--text);border-bottom-color:var(--oyster-teal);}
.tab:hover{color:var(--text);}
#panel-content{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch;}
#panel-content::-webkit-scrollbar{width:4px;}
#panel-content::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:2px;}

/* RIGHT PANEL */
#right-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#map-container{flex:1;position:relative;overflow:hidden;background:var(--bg);}
#tube-map{width:100%;height:100%;}

/* GAME OVERLAY */
#game-overlay{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(0deg,rgba(10,14,26,0.97) 0%,rgba(10,14,26,0.8) 60%,transparent 100%);
  padding:10px 12px;
}

/* STATION TOOLTIP */
#station-tooltip{
  position:absolute;
  background:rgba(0,0,0,0.92);border:2px solid var(--oyster-teal);border-radius:10px;
  padding:6px 12px;font-size:13px;font-weight:900;color:var(--text);
  pointer-events:none;z-index:30;white-space:nowrap;
  transform:translate(-50%,-120%);display:none;
}

/* MISSION CARD */
.mission-card{
  background:var(--surface2);border:2px solid var(--tfl-navy);border-radius:16px;
  padding:12px;margin-bottom:10px;
}
.mission-card h3{font-family:var(--font-h);font-size:clamp(15px,2.8vw,22px);letter-spacing:1px;
  color:var(--oyster-teal);margin-bottom:6px;}
.mission-detail{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.mission-badge{background:var(--surface);border-radius:8px;padding:4px 10px;
  font-size:clamp(11px,1.8vw,14px);font-weight:700;}
.mission-route{font-size:clamp(13px,2.3vw,18px);font-weight:900;
  background:linear-gradient(90deg,var(--tfl-red),var(--elizabeth));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* SLOTS */
#slots{background:var(--surface2);border:3px solid var(--gold);border-radius:20px;
  padding:12px;margin-bottom:10px;}
#slots h3{font-family:var(--font-h);font-size:clamp(16px,3vw,26px);letter-spacing:2px;
  color:var(--gold);text-align:center;margin-bottom:10px;}
#reels{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.reel{
  width:clamp(65px,16vw,95px);height:clamp(48px,9vh,68px);
  background:var(--surface);border:2px solid var(--text-dim);border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
  font-size:clamp(10px,1.8vw,15px);font-weight:900;text-align:center;transition:all 0.3s;
}
.reel.spinning{animation:reelSpin 0.15s linear infinite;}
.reel.landed{border-color:var(--gold);animation:reelLand 0.3s ease-out;}
@keyframes reelSpin{0%{transform:translateY(-4px);}50%{transform:translateY(4px);}100%{transform:translateY(-4px);}}
@keyframes reelLand{0%{transform:scale(1.15);}100%{transform:scale(1);}}
.reel-label{font-size:clamp(8px,1.3vw,11px);color:var(--text-dim);text-align:center;margin-bottom:2px;}

/* BIG BUTTONS */
.btn-big{
  width:100%;padding:clamp(11px,2.5vh,18px) 16px;
  border-radius:14px;border:none;cursor:pointer;
  font-family:var(--font-h);font-size:clamp(17px,3.5vw,28px);
  letter-spacing:2px;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:8px;
  touch-action:manipulation;margin-bottom:8px;
}
.btn-big:active{transform:scale(0.96);}
.btn-spin{background:linear-gradient(135deg,var(--gold),#FF8C00);color:#000;}
.btn-spin:hover{filter:brightness(1.1);}
.btn-travel{background:linear-gradient(135deg,#00A86B,#00C851);color:#fff;}
.btn-travel:disabled{background:#2A3040;color:#555;cursor:not-allowed;}
.btn-secondary{background:var(--surface2);color:var(--text);border:2px solid var(--text-dim);}
.btn-hint{background:linear-gradient(135deg,var(--elizabeth),#9B59B6);color:#fff;}
.btn-undo{background:linear-gradient(135deg,#555,#777);color:#fff;}
.btn-small{
  padding:8px 14px;border-radius:10px;border:none;cursor:pointer;
  font-family:var(--font-b);font-size:clamp(13px,2.3vw,17px);font-weight:900;
  transition:all 0.2s;touch-action:manipulation;
}
.btn-small:active{transform:scale(0.95);}
#btn-row{display:flex;gap:8px;margin-bottom:8px;}

/* CARDS */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(clamp(78px,14vw,115px),1fr));gap:8px;}
.tube-card{
  border-radius:12px;padding:8px;cursor:pointer;
  transition:all 0.3s;position:relative;overflow:hidden;
  border:2px solid rgba(255,255,255,0.12);background:var(--card-bg);
}
.tube-card:hover{transform:translateY(-3px);border-color:rgba(255,255,255,0.35);}
.tube-card.selected{border-color:var(--gold);box-shadow:0 0 12px var(--gold);}
.tube-card .card-line{font-family:var(--font-h);font-size:17px;letter-spacing:1px;}
.tube-card .card-name{font-size:clamp(8px,1.3vw,11px);font-weight:900;margin:3px 0;line-height:1.2;}
.tube-card .card-stats{font-size:clamp(7px,1.2vw,10px);color:rgba(255,255,255,0.7);}
.tube-card .card-ability{font-size:clamp(7px,1.1vw,10px);color:rgba(255,255,255,0.55);font-style:italic;margin-top:3px;line-height:1.2;}

/* PB TABLE */
.pb-table{width:100%;border-collapse:collapse;font-size:clamp(10px,1.8vw,14px);}
.pb-table th{background:var(--surface2);padding:7px;text-align:left;font-family:var(--font-h);
  font-size:clamp(11px,1.8vw,15px);letter-spacing:1px;border-bottom:2px solid var(--tfl-red);}
.pb-table td{padding:5px 7px;border-bottom:1px solid var(--surface2);}
.pb-table tr:hover td{background:var(--surface2);}

/* FARE PREVIEW */
#fare-preview{
  background:rgba(30,42,64,0.9);border:2px solid var(--elizabeth);border-radius:12px;
  padding:8px 12px;margin:6px 0;font-size:clamp(12px,2vw,16px);
}
#fare-preview strong{color:var(--elizabeth);}

/* PATH DISPLAY */
.path-node{display:inline-flex;align-items:center;gap:3px;margin:2px;
  background:var(--surface2);border-radius:7px;padding:3px 7px;
  font-size:clamp(9px,1.6vw,13px);font-weight:900;}

/* HINT BOX */
#hint-box{background:var(--surface2);border:2px solid var(--elizabeth);border-radius:12px;
  padding:10px;margin:6px 0;font-size:clamp(12px,1.9vw,16px);display:none;}
#hint-box.show{display:block;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}

/* PHASE BANNER */
#phase-banner{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.88);border:2px solid var(--oyster-teal);border-radius:12px;
  padding:6px 18px;font-family:var(--font-h);font-size:clamp(13px,2.5vw,20px);
  letter-spacing:2px;color:var(--oyster-teal);z-index:15;pointer-events:none;
  white-space:nowrap;
}

/* TIMER */
#timer-display{
  position:absolute;top:10px;right:10px;
  background:rgba(0,0,0,0.88);border:2px solid var(--tfl-red);border-radius:12px;
  padding:5px 12px;font-family:var(--font-h);font-size:clamp(18px,3.5vw,28px);
  color:var(--tfl-red);z-index:15;letter-spacing:2px;
}

/* TRAIN */
#train-marker{
  position:absolute;width:32px;height:18px;
  background:var(--tfl-red);border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;z-index:20;
  box-shadow:0 0 14px rgba(225,27,34,0.9);
  transition:left 0.7s ease-in-out, top 0.7s ease-in-out;
  pointer-events:none;
}

/* EVENT POPUP */
#event-popup{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0);
  background:var(--surface2);border:3px solid var(--gold);border-radius:20px;
  padding:18px 26px;text-align:center;z-index:50;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);min-width:190px;
}
#event-popup.show{transform:translate(-50%,-50%) scale(1);}
#event-popup h2{font-family:var(--font-h);font-size:clamp(20px,4.5vw,34px);margin-bottom:6px;}
#event-popup p{font-size:clamp(13px,2.2vw,18px);margin-bottom:10px;}

/* MODAL */
#modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:100;
  display:flex;align-items:center;justify-content:center;padding:16px;}
#modal-overlay.hidden{display:none;}
#modal-box{background:var(--surface);border:3px solid var(--tfl-red);border-radius:20px;
  padding:20px;max-width:540px;width:100%;max-height:90vh;overflow-y:auto;}
#modal-box h2{font-family:var(--font-h);font-size:clamp(20px,4.5vw,34px);letter-spacing:2px;
  color:var(--tfl-red);margin-bottom:10px;}
#modal-box p{font-size:clamp(13px,2.2vw,17px);line-height:1.6;margin-bottom:10px;color:var(--text-dim);}
.modal-step{background:var(--surface2);border-radius:12px;padding:10px 14px;margin-bottom:8px;
  font-size:clamp(13px,2.2vw,17px);line-height:1.5;}
.modal-step em{color:var(--oyster-teal);font-style:normal;font-weight:900;}

/* RESULT */
#result-screen{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:90;
  display:flex;align-items:center;justify-content:center;padding:16px;}
#result-screen.hidden{display:none;}
#result-box{background:var(--surface);border:4px solid var(--gold);border-radius:24px;
  padding:22px;max-width:460px;width:100%;text-align:center;}
#result-box h2{font-family:var(--font-h);font-size:clamp(26px,6.5vw,44px);letter-spacing:3px;margin-bottom:6px;}
.result-stat{font-size:clamp(15px,2.8vw,20px);margin:5px 0;font-weight:700;}
.result-score{font-family:var(--font-h);font-size:clamp(38px,9vw,68px);color:var(--gold);}
.result-cards{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0;}

/* GALLERY */
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(85px,1fr));gap:6px;}
.gallery-slot{aspect-ratio:0.7;border-radius:10px;background:var(--surface2);
  border:2px dashed var(--text-dim);display:flex;align-items:center;justify-content:center;
  font-size:22px;color:var(--text-dim);}
.milestone-badge{background:linear-gradient(135deg,var(--gold),#FF8C00);color:#000;
  border-radius:12px;padding:7px 12px;margin-bottom:7px;
  font-size:clamp(11px,1.8vw,15px);font-weight:900;display:flex;align-items:center;gap:7px;}
.market-card{background:var(--surface2);border-radius:14px;padding:10px;margin-bottom:8px;
  display:flex;align-items:center;gap:10px;border:2px solid transparent;cursor:pointer;transition:all 0.2s;}
.market-card:hover{border-color:var(--gold);}
.market-card-info{flex:1;}
.market-card-info h4{font-size:clamp(12px,2.2vw,16px);font-weight:900;}
.market-card-info p{font-size:clamp(10px,1.8vw,13px);color:var(--text-dim);}
.market-price{font-family:var(--font-h);font-size:clamp(15px,2.8vw,22px);color:var(--gold);}
.progress-bar{background:var(--surface2);border-radius:99px;height:7px;overflow:hidden;margin:4px 0;}
.progress-fill{height:100%;border-radius:99px;transition:width 0.5s ease;
  background:linear-gradient(90deg,var(--oyster-teal),var(--tfl-blue));}
#share-code{margin-top:8px;}

/* DIRECTION PICKER */
#direction-picker{
  background:var(--surface2);border:2px solid var(--gold);border-radius:14px;
  padding:10px;margin:8px 0;display:none;
}
#direction-picker h4{font-family:var(--font-h);font-size:18px;color:var(--gold);margin-bottom:8px;text-align:center;}
#direction-picker .dir-btns{display:flex;gap:8px;}
.dir-btn{flex:1;padding:10px;border-radius:10px;border:2px solid var(--text-dim);
  background:var(--surface);color:var(--text);cursor:pointer;font-family:var(--font-h);
  font-size:16px;letter-spacing:1px;transition:all 0.2s;text-align:center;}
.dir-btn:hover,.dir-btn.selected{border-color:var(--gold);background:var(--surface2);color:var(--gold);}

/* MOBILE */
@media(max-width:600px){
  #left-panel{width:100%;border-right:none;border-bottom:2px solid var(--surface2);max-height:52vh;min-height:0;}
  #main{flex-direction:column;}
}
button:focus-visible{outline:3px solid var(--oyster-teal);outline-offset:2px;}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
#loading h1{font-family:var(--font-h);font-size:clamp(30px,7vw,56px);letter-spacing:4px;
  background:linear-gradient(90deg,var(--tfl-red),var(--elizabeth));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.loading-bar{width:200px;height:6px;background:var(--surface2);border-radius:99px;overflow:hidden;}
.loading-fill{height:100%;background:linear-gradient(90deg,var(--tfl-red),var(--oyster-teal));
  animation:loadPulse 1.2s ease-in-out infinite;}
@keyframes loadPulse{0%{width:0%;margin-left:0;}50%{width:70%;margin-left:15%;}100%{width:0%;margin-left:100%;}}

/* MAP PAN/ZOOM */
#map-container{cursor:grab;}
#map-container:active{cursor:grabbing;}
</style>
</head>
<body>

<div id="loading">
  <h1>üöá TUBE QUEST</h1>
  <p style="font-size:17px;color:var(--text-dim)">Loading the Underground...</p>
  <div class="loading-bar"><div class="loading-fill"></div></div>
  <p style="font-size:13px;color:var(--text-dim)">v2 ¬∑ Clean Map Edition</p>
</div>

<div id="app" style="display:none">
  <div id="header">
    <h1>üöá TUBE QUEST</h1>
    <div id="oyster-bar">
      <div class="oyster-chip" id="oyster-display">üÉè ¬£20.00</div>
      <div class="streak-chip" id="streak-display">üî• 0</div>
      <button class="btn-secondary btn-small" id="btn-slow" title="Slow Mode">üê¢</button>
      <button class="btn-secondary btn-small" id="btn-mute" title="Mute">üîä</button>
      <button class="btn-secondary btn-small" id="btn-fullscreen" title="Fullscreen">‚õ∂</button>
    </div>
  </div>

  <div id="main">
    <!-- LEFT -->
    <div id="left-panel">
      <div id="tabs">
        <button class="tab active" onclick="showTab('game')" id="tab-game">üéÆ PLAY</button>
        <button class="tab" onclick="showTab('cards')" id="tab-cards">üÉè DECK</button>
        <button class="tab" onclick="showTab('scores')" id="tab-scores">üèÜ PBs</button>
        <button class="tab" onclick="showTab('gallery')" id="tab-gallery">üìñ ALL</button>
      </div>
      <div id="panel-content">

        <!-- GAME TAB -->
        <div id="tab-content-game">
          <div id="mission-card" class="mission-card">
            <h3>üé∞ SPIN FOR MISSION</h3>
            <p style="color:var(--text-dim);font-size:13px">Press SPIN to begin your Tube Quest!</p>
          </div>

          <div id="slots">
            <h3>üé∞ MISSION SLOT</h3>
            <div id="reels">
              <div><div class="reel-label">START</div>
                <div class="reel" id="reel-start">üöá<br><span style="font-size:9px">???</span></div></div>
              <div><div class="reel-label">END</div>
                <div class="reel" id="reel-end">üèÅ<br><span style="font-size:9px">???</span></div></div>
              <div><div class="reel-label">GOAL</div>
                <div class="reel" id="reel-goal">üéØ<br><span style="font-size:9px">???</span></div></div>
            </div>
            <button class="btn-big btn-spin" id="btn-spin" onclick="spinMission()">
              üé∞ SPIN! (¬£20 BET)
            </button>
          </div>

          <div id="hint-box">üí° <span id="hint-text">...</span></div>

          <div id="btn-row">
            <button class="btn-small btn-hint" onclick="showHint()" style="flex:1">üí° HINT</button>
            <button class="btn-small btn-undo" onclick="undoLastStation()" style="flex:1">‚Ü© UNDO</button>
          </div>

          <div id="direction-picker">
            <h4>üîÑ WHICH WAY ROUND?</h4>
            <div class="dir-btns">
              <div class="dir-btn" id="dir-cw" onclick="setDirection('cw')">‚Üª CLOCKWISE</div>
              <div class="dir-btn" id="dir-acw" onclick="setDirection('acw')">‚Ü∫ ANTI-CLOCK</div>
            </div>
          </div>

          <div id="build-section" style="display:none">
            <div id="fare-preview">
              <strong>üó∫Ô∏è Stops:</strong> <span id="route-display">‚Äî</span><br>
              <strong>üí∞ Fare:</strong> <span id="fare-display">¬£0.00</span> &nbsp;
              <strong>‚è± Time:</strong> <span id="time-display">0 min</span> &nbsp;
              <strong>üîÑ Changes:</strong> <span id="changes-display">0</span>
            </div>
            <button class="btn-big btn-travel" id="btn-travel" onclick="startTravel()" disabled>
              üöÇ TRAVEL!
            </button>
          </div>
        </div>

        <!-- CARDS TAB -->
        <div id="tab-content-cards" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:22px;margin-bottom:6px;color:var(--oyster-teal)">üÉè ACTIVE DECK (5 max)</h3>
          <p style="font-size:12px;color:var(--text-dim);margin-bottom:8px">Tap to toggle active (gold border = active)</p>
          <div class="card-grid" id="deck-grid"></div>
          <h3 style="font-family:var(--font-h);font-size:20px;margin:10px 0 6px;color:var(--text-dim)">üóÉÔ∏è COLLECTION</h3>
          <div class="card-grid" id="collection-grid"></div>
        </div>

        <!-- SCORES TAB -->
        <div id="tab-content-scores" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:22px;margin-bottom:8px;color:var(--gold)">üèÜ PERSONAL BESTS</h3>
          <div id="milestones-area"></div>
          <table class="pb-table">
            <thead><tr><th>Route</th><th>Score</th><th>Min</th></tr></thead>
            <tbody id="pb-tbody"></tbody>
          </table>
          <h3 style="font-family:var(--font-h);font-size:20px;margin:12px 0 6px;color:var(--tfl-red)">üíÄ WORST RUNS</h3>
          <table class="pb-table">
            <thead><tr><th>Route</th><th>Score</th><th>Min</th></tr></thead>
            <tbody id="worst-tbody"></tbody>
          </table>
        </div>

        <!-- GALLERY TAB -->
        <div id="tab-content-gallery" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:22px;margin-bottom:4px;color:var(--elizabeth)">üìñ CARD GALLERY</h3>
          <p style="font-size:12px;color:var(--text-dim);margin-bottom:6px">
            <span id="gallery-count">0</span>/24 collected</p>
          <div class="progress-bar"><div class="progress-fill" id="gallery-progress" style="width:0%"></div></div>
          <div class="gallery-grid" id="gallery-grid" style="margin-top:8px"></div>
          <h3 style="font-family:var(--font-h);font-size:20px;margin:10px 0 6px;color:var(--warn)">üèÖ MILESTONES</h3>
          <div id="milestone-list"></div>
          <h3 style="font-family:var(--font-h);font-size:20px;margin:10px 0 6px;color:var(--gold)">üì§ SHARE</h3>
          <button class="btn-big btn-secondary" onclick="shareChallenge()" style="font-size:17px;margin-bottom:4px">
            üì§ SHARE CHALLENGE LINK
          </button>
          <div id="share-code"></div>
          <h3 style="font-family:var(--font-h);font-size:20px;margin:10px 0 6px;color:var(--oyster-teal)">üí± CARD MARKET</h3>
          <div id="market-area"></div>
        </div>

      </div>
    </div>

    <!-- RIGHT: MAP -->
    <div id="right-panel">
      <div id="map-container">
        <div id="phase-banner">üé∞ SPIN TO START</div>
        <div id="timer-display" style="display:none">‚è± 0:00</div>
        <svg id="tube-map" viewBox="0 0 800 700" xmlns="http://www.w3.org/2000/svg" style="touch-action:none;"></svg>
        <div id="train-marker" style="display:none">üöÇ</div>
        <div id="station-tooltip"></div>
        <div id="event-popup">
          <h2 id="event-icon">‚ö°</h2>
          <p id="event-msg">Event!</p>
          <button class="btn-small btn-secondary" onclick="dismissEvent()">OK</button>
        </div>
        <div id="game-overlay">
          <div id="build-section-map" style="display:none">
            <p style="font-size:12px;color:var(--text-dim);margin-bottom:4px">
              üëÜ Tap stations to build your route ‚Ä¢ Enter Circle at an interchange
            </p>
            <div id="path-display" style="display:flex;flex-wrap:wrap;gap:3px;min-height:26px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL -->
<div id="modal-overlay" class="hidden">
  <div id="modal-box">
    <h2>üöá WELCOME TO<br>TUBE QUEST v2!</h2>
    <p>Navigate the Circle line to beat missions and collect legendary Tube Cards!</p>
    <div class="modal-step"><em>1. SPIN</em> ‚Äî Bet ¬£20 on the slot machine. You get a START station (spoke), END station (different spoke), and a GOAL to beat.</div>
    <div class="modal-step"><em>2. BUILD</em> ‚Äî Tap your start station, tap an interchange to enter the Circle, pick ‚Üª or ‚Ü∫ direction, travel the rim, exit to your destination spoke.</div>
    <div class="modal-step"><em>3. TRAVEL</em> ‚Äî Watch your train race! Random events: delays üò§, muggings üòà, bonuses üéÅ</div>
    <div class="modal-step"><em>4. WIN</em> ‚Äî Beat the goal ‚Üí earn rare Tube Cards with special powers.</div>
    <div class="modal-step"><em>üí° HINT</em> shows the optimal route &nbsp;|&nbsp; <em>‚Ü© UNDO</em> removes last tap &nbsp;|&nbsp; <em>üê¢</em> slows timers</div>
    <p style="color:var(--gold);font-weight:900;font-size:15px">Start with ¬£20. Lower score = better. Good luck! üöá</p>
    <button class="btn-big btn-spin" onclick="closeTutorial()" style="margin-top:10px">üöá LET'S GO!</button>
  </div>
</div>

<!-- RESULT -->
<div id="result-screen" class="hidden">
  <div id="result-box">
    <h2 id="result-title">üèÜ MISSION COMPLETE!</h2>
    <div class="result-score" id="result-score">0</div>
    <p style="font-size:13px;color:var(--text-dim)">SCORE (lower = better)</p>
    <div class="result-stat" id="result-time">‚è± Time: ‚Äî</div>
    <div class="result-stat" id="result-changes">üîÑ Changes: ‚Äî</div>
    <div class="result-stat" id="result-fare">üí∞ Fare: ‚Äî</div>
    <div class="result-stat" id="result-oyster">üÉè Oyster: ‚Äî</div>
    <div class="result-stat" id="result-pb">üèÖ ‚Äî</div>
    <h3 style="font-family:var(--font-h);font-size:20px;color:var(--gold);margin:8px 0 5px">CARDS WON:</h3>
    <div class="result-cards" id="result-cards"></div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button class="btn-big btn-spin" onclick="closeResult()" style="flex:1;font-size:19px">üé∞ AGAIN!</button>
      <button class="btn-big btn-secondary" onclick="shareResult()" style="flex:1;font-size:19px">üì§ SHARE</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// LINE COLORS
// ============================================================
const lineColors = {
  B:'#B36305', C:'#FF0000', Ci:'#FFCD00', D:'#00782A', H:'#F3A9BB',
  J:'#A0998A', M:'#9B3777', N:'#1C1C1C', P:'#0019A8', V:'#0098D4',
  W:'#76D0BD', E:'#603A9E'
};
const lineNames = {
  B:'Bakerloo',C:'Central',Ci:'Circle',D:'District',H:'Hammersmith & City',
  J:'Jubilee',M:'Metropolitan',N:'Northern',P:'Piccadilly',V:'Victoria',
  W:'Waterloo & City',E:'Elizabeth'
};

// ============================================================
// BICYCLE WHEEL MAP DATA
// ============================================================
// Circle line stations in order (clockwise), with their SVG positions
// The circle is centred around ~(400, 340) with radius ~210
// Positions hand-crafted to form a near-circle with gap at Edgware Road

const circleStations = [
  // id, name, [x,y], isInterchange
  {id:'HMD', name:'Hammersmith',         pos:[148,340], interchange:true},
  {id:'GOL', name:'Goldhawk Road',        pos:[155,295], interchange:false},
  {id:'SBM', name:"Shepherd's Bush Mkt", pos:[175,260], interchange:false},
  {id:'WLN', name:'Wood Lane',            pos:[200,235], interchange:false},
  {id:'LAT', name:'Latimer Road',         pos:[230,215], interchange:false},
  {id:'LGV', name:'Ladbroke Grove',       pos:[260,205], interchange:false},
  {id:'WBP', name:'Westbourne Park',      pos:[295,200], interchange:false},
  {id:'ROK', name:'Royal Oak',            pos:[325,198], interchange:false},
  {id:'PAD', name:'Paddington',           pos:[355,202], interchange:true},
  {id:'EDG', name:'Edgware Road',         pos:[385,210], interchange:true},
  // Gap here - no direct connection EDG‚ÜíBST on Circle (it loops back)
  {id:'BST', name:'Baker Street',         pos:[390,248], interchange:true},
  {id:'GPT', name:'Great Portland St',    pos:[410,258], interchange:false},
  {id:'EUS', name:'Euston Square',        pos:[432,258], interchange:false},
  {id:'KXX', name:"King's Cross St P",    pos:[455,252], interchange:true},
  {id:'FAR', name:'Farringdon',           pos:[490,248], interchange:true},
  {id:'BGR', name:'Barbican',             pos:[510,252], interchange:false},
  {id:'MOG', name:'Moorgate',             pos:[530,265], interchange:true},
  {id:'LST', name:'Liverpool Street',     pos:[548,285], interchange:true},
  {id:'ALD', name:'Aldgate',              pos:[558,312], interchange:true},
  {id:'TOW', name:'Tower Hill',           pos:[558,342], interchange:true},
  {id:'MON', name:'Monument',             pos:[548,368], interchange:true},
  {id:'CAN', name:'Cannon Street',        pos:[528,388], interchange:false},
  {id:'MAN', name:'Mansion House',        pos:[505,400], interchange:false},
  {id:'BLA', name:'Blackfriars',          pos:[480,408], interchange:false},
  {id:'TMP', name:'Temple',               pos:[452,412], interchange:false},
  {id:'EMB', name:'Embankment',           pos:[425,410], interchange:true},
  {id:'WMS', name:'Westminster',          pos:[400,410], interchange:true},
  {id:'SDM', name:"St James's Park",      pos:[375,408], interchange:false},
  {id:'VIC', name:'Victoria',             pos:[348,408], interchange:true},
  {id:'SSQ', name:'Sloane Square',        pos:[318,408], interchange:false},
  {id:'SKN', name:'South Kensington',     pos:[290,400], interchange:true},
  {id:'GRD', name:'Gloucester Road',      pos:[265,385], interchange:true},
  {id:'HSK', name:'High St Kensington',   pos:[242,365], interchange:true},
  {id:'NHG', name:'Notting Hill Gate',    pos:[222,340], interchange:true},
  {id:'BAY', name:'Bayswater',            pos:[190,325], interchange:false},
  {id:'PAD2',name:'Paddington (West)',    pos:[165,330], interchange:true},
  // connects back to Hammersmith area (no full close - spiral)
];

// Spoke stations (outer) ‚Äî keyed by interchange id they branch from
const spokeStations = {
  'HMD': [
    {id:'BEC', name:'Beaconsfield Rd',  pos:[90,340],  line:'D'},
    {id:'RVS', name:'Ravenscourt Park', pos:[60,340],  line:'D'},
    {id:'STB', name:'Stamford Brook',   pos:[35,340],  line:'D'},
  ],
  'PAD': [
    {id:'PCC', name:'Paddington (B)',   pos:[340,165], line:'B'},
    {id:'QWY', name:'Queens Way',       pos:[320,140], line:'B'},
    {id:'ELW', name:'Ealing Broadway',  pos:[300,118], line:'E'},
    {id:'HT2', name:'Heathrow T2&3',    pos:[270,100], line:'E'},
  ],
  'EDG': [
    {id:'MBN', name:'Marylebone',       pos:[400,170], line:'B'},
    {id:'KIL', name:'Kilburn',          pos:[400,135], line:'B'},
  ],
  'BST': [
    {id:'FNR', name:'Finchley Road',    pos:[365,210], line:'J'},
    {id:'WPN', name:'Wembley Park',     pos:[340,175], line:'J'},
    {id:'HRW', name:'Harrow-on-Hill',   pos:[320,148], line:'M'},
  ],
  'KXX': [
    {id:'ANG', name:'Angel',            pos:[490,215], line:'N'},
    {id:'HIG', name:'Highbury & Isl.',  pos:[510,185], line:'V'},
    {id:'FIN', name:'Finsbury Park',    pos:[490,158], line:'P'},
    {id:'EUS2',name:'Euston',           pos:[450,218], line:'V'},
  ],
  'FAR': [
    {id:'CXR', name:'Chancery Lane',    pos:[490,275], line:'C'},
    {id:'HOL', name:'Holborn',          pos:[490,298], line:'C'},
  ],
  'MOG': [
    {id:'OLD', name:'Old Street',       pos:[558,248], line:'N'},
  ],
  'LST': [
    {id:'BTS', name:'Bethnal Green',    pos:[590,268], line:'C'},
    {id:'STR', name:'Stratford',        pos:[630,268], line:'C'},
    {id:'WCH', name:'Whitechapel',      pos:[588,298], line:'E'},
    {id:'CWH', name:'Canary Wharf',     pos:[618,325], line:'E'},
  ],
  'ALD': [
    {id:'ALB', name:'Aldgate East',     pos:[585,325], line:'D'},
    {id:'WHC', name:'Whitechapel (D)',  pos:[608,342], line:'D'},
  ],
  'TOW': [
    {id:'BER', name:'Bermondsey',       pos:[575,368], line:'J'},
    {id:'LBR', name:'London Bridge',    pos:[565,395], line:'N'},
  ],
  'EMB': [
    {id:'WLO', name:'Waterloo',         pos:[435,438], line:'J'},
    {id:'CHX', name:'Charing Cross',    pos:[418,440], line:'N'},
  ],
  'WMS': [
    {id:'LAM', name:'Lambeth North',    pos:[388,440], line:'B'},
    {id:'ELP', name:'Elephant & C.',    pos:[388,468], line:'N'},
  ],
  'VIC': [
    {id:'PIK', name:'Pimlico',          pos:[335,438], line:'V'},
    {id:'STK', name:'Stockwell',        pos:[328,468], line:'V'},
    {id:'BRI', name:'Brixton',          pos:[318,500], line:'V'},
  ],
  'SKN': [
    {id:'KNT', name:'Knightsbridge',    pos:[302,375], line:'P'},
    {id:'GPK', name:'Green Park',       pos:[318,358], line:'J'},
    {id:'HYC', name:'Hyde Park Corner', pos:[295,355], line:'P'},
  ],
  'GRD': [
    {id:'ERP', name:'Earl\'s Court',    pos:[238,400], line:'D'},
    {id:'FUL', name:'Fulham Broadway',  pos:[215,422], line:'D'},
    {id:'WIM', name:'Wimbledon',        pos:[192,445], line:'D'},
  ],
  'HSK': [
    {id:'ACT', name:'Acton Town',       pos:[200,385], line:'P'},
    {id:'OST', name:'Osterley',         pos:[172,402], line:'P'},
  ],
  'NHG': [
    {id:'QBY', name:'Queensway',        pos:[210,312], line:'C'},
    {id:'MBL', name:'Marble Arch',      pos:[232,298], line:'C'},
    {id:'BON', name:'Bond Street',      pos:[252,280], line:'J'},
    {id:'OXC', name:'Oxford Circus',    pos:[270,262], line:'V'},
  ],
  'PAD2': [
    {id:'WDB', name:'Westbourne Pk (B)',pos:[138,310], line:'H'},
    {id:'KIL2',name:'Kilburn Park',     pos:[115,292], line:'B'},
  ],
};

// Flat list of all stations
const allStations = {};
circleStations.forEach(s => { allStations[s.id] = s; });
Object.values(spokeStations).flat().forEach(s => { allStations[s.id] = s; });

// Zone assignments (for fare calc)
const zones = {
  'HMD':2,'GOL':2,'SBM':2,'WLN':2,'LAT':2,'LGV':2,'WBP':2,'ROK':2,
  'PAD':1,'EDG':1,'BST':1,'GPT':1,'EUS':1,'KXX':1,'FAR':1,'BGR':1,
  'MOG':1,'LST':1,'ALD':1,'TOW':1,'MON':1,'CAN':1,'MAN':1,'BLA':1,
  'TMP':1,'EMB':1,'WMS':1,'SDM':1,'VIC':1,'SSQ':1,'SKN':1,'GRD':2,
  'HSK':2,'NHG':2,'BAY':2,'PAD2':1,
  // Spokes
  'BEC':3,'RVS':3,'STB':3,'PCC':1,'QWY':2,'ELW':3,'HT2':6,
  'MBN':1,'KIL':2,'FNR':2,'WPN':4,'HRW':5,
  'ANG':1,'HIG':2,'FIN':2,'EUS2':1,
  'CXR':1,'HOL':1,'OLD':1,'BTS':2,'STR':3,'WCH':2,'CWH':2,
  'ALB':2,'WHC':2,'BER':1,'LBR':1,
  'WLO':1,'CHX':1,'LAM':1,'ELP':1,
  'PIK':1,'STK':2,'BRI':2,
  'KNT':1,'GPK':1,'HYC':1,'ERP':2,'FUL':2,'WIM':3,
  'ACT':3,'OST':4,'QBY':1,'MBL':1,'BON':1,'OXC':1,
  'WDB':2,'KIL2':2
};

// ============================================================
// GRAPH BUILDING
// ============================================================
const graph = {};

function initGraph(s) { if (!graph[s]) graph[s] = []; }

function addEdge(a, b, time, line) {
  initGraph(a); initGraph(b);
  graph[a].push({to:b, time, line});
  graph[b].push({to:a, time, line});
}

function buildGraph() {
  // Circle line edges (clockwise sequence)
  for (let i = 0; i < circleStations.length - 1; i++) {
    const a = circleStations[i].id;
    const b = circleStations[i+1].id;
    // Skip the gap: EDG ‚Üí BST is NOT a direct circle connection (it's the break)
    // The Circle actually runs: ...PAD ‚Üí EDG (end of one direction) and BST ‚Üí ... (other direction)
    // For gameplay: PAD2 loops back to HMD completing the western arc
    if (a === 'EDG' && b === 'BST') {
      // No direct edge - player must change here
      continue;
    }
    addEdge(a, b, 3, 'Ci');
  }
  // Close the western arc: PAD2 ‚Üí HMD
  addEdge('PAD2', 'HMD', 3, 'Ci');
  // PAD ‚Üí PAD2 interchange (same station different platforms)
  addEdge('PAD', 'PAD2', 2, 'Ci');

  // Spoke edges
  Object.entries(spokeStations).forEach(([interchange, spokes]) => {
    // Interchange to first spoke
    if (spokes.length > 0) {
      addEdge(interchange, spokes[0].id, 3, spokes[0].line);
      // Chain spokes
      for (let i = 0; i < spokes.length - 1; i++) {
        addEdge(spokes[i].id, spokes[i+1].id, 3, spokes[i+1].line);
      }
    }
  });
  // Special: PAD and PAD2 both connect to their spokes
}

function bfs(start, end) {
  if (start === end) return {path:[start], time:0, changes:0};
  const queue = [{node:start, path:[start], time:0, changes:0, lastLine:null}];
  const visited = new Map();
  while (queue.length) {
    queue.sort((a,b)=>a.time-b.time);
    const {node, path, time, changes, lastLine} = queue.shift();
    const key = `${node}:${lastLine}`;
    if (visited.has(key)) continue;
    visited.set(key, true);
    for (const edge of (graph[node]||[])) {
      if (path.includes(edge.to)) continue;
      const isChange = lastLine && lastLine !== edge.line;
      const addTime = edge.time + (isChange ? 4 : 0);
      const newPath = [...path, edge.to];
      if (edge.to === end) return {path:newPath, time:time+addTime, changes:changes+(isChange?1:0)};
      queue.push({node:edge.to, path:newPath, time:time+addTime,
        changes:changes+(isChange?1:0), lastLine:edge.line});
    }
  }
  return null;
}

function getEdgeLine(a, b) {
  const e = (graph[a]||[]).find(x=>x.to===b);
  return e ? e.line : null;
}

// ============================================================
// CARD DEFINITIONS
// ============================================================
const cardDefs = [
  {id:'E01',name:'Elizabeth Express',line:'E',color:'#603A9E',stats:{speed:9,crowd:3},ability:'-2min on E-line'},
  {id:'E02',name:'Crossrail Commuter',line:'E',color:'#7B4FB5',stats:{speed:8,crowd:4},ability:'Free Z1‚ÜíZ2 transfer'},
  {id:'E03',name:'Heathrow Hopper',line:'E',color:'#5A2E8A',stats:{speed:7,crowd:5},ability:'Airport bonus x1.5'},
  {id:'V01',name:'Victoria Viper',line:'V',color:'#0098D4',stats:{speed:9,crowd:5},ability:'Rush: skip 1 event'},
  {id:'V02',name:'Victoria Veteran',line:'V',color:'#0077AA',stats:{speed:7,crowd:6},ability:'Rare: +10 score'},
  {id:'J01',name:'Jubilee Jet',line:'J',color:'#A0998A',stats:{speed:8,crowd:4},ability:'Docks fast -1min'},
  {id:'J02',name:'Jubilee Ninja',line:'J',color:'#7A7080',stats:{speed:7,crowd:5},ability:'Dodge 1 Mug event'},
  {id:'N01',name:'Northern Nightmare',line:'N',color:'#444',stats:{speed:5,crowd:9},ability:'Night bonus double ¬£'},
  {id:'N02',name:'Bank Bandit',line:'N',color:'#222',stats:{speed:7,crowd:6},ability:'BNK transfer free'},
  {id:'C01',name:'Central Champ',line:'C',color:'#FF0000',stats:{speed:8,crowd:7},ability:'EAL fast express'},
  {id:'C02',name:'Red Racer',line:'C',color:'#CC0000',stats:{speed:9,crowd:6},ability:'-1min per C station'},
  {id:'P01',name:'Piccadilly Pioneer',line:'P',color:'#0019A8',stats:{speed:7,crowd:6},ability:'HT fast +¬£2 bonus'},
  {id:'B01',name:'Bakerloo Baker',line:'B',color:'#B36305',stats:{speed:5,crowd:7},ability:'OXC free change'},
  {id:'D01',name:'District Dasher',line:'D',color:'#00782A',stats:{speed:6,crowd:6},ability:'WIM express -2min'},
  {id:'Ci01',name:'Circle Spinner',line:'Ci',color:'#FFCD00',stats:{speed:5,crowd:5},ability:'Loop bonus free ¬£'},
  {id:'Ci02',name:'Yellow Jacket',line:'Ci',color:'#E6B800',stats:{speed:6,crowd:4},ability:'Circle always clockwise'},
  {id:'M01',name:'Metro Master',line:'M',color:'#9B3777',stats:{speed:6,crowd:4},ability:'HRW rare +card'},
  {id:'W01',name:'Waterloo Wave',line:'W',color:'#76D0BD',stats:{speed:9,crowd:3},ability:'2-stop blitz -3min'},
  {id:'SPEC1',name:'‚≠ê Rush Hour Hero',line:'E',color:'#FFD700',stats:{speed:10,crowd:2},ability:'Legendary: all -3min'},
  {id:'SPEC2',name:'üëë Oyster King',line:'J',color:'#FF8C00',stats:{speed:8,crowd:2},ability:'All fares -20%'},
  {id:'SPEC3',name:'üåô Night Tube Legend',line:'N',color:'#1A1A2E',stats:{speed:7,crowd:1},ability:'Events give ¬£ instead'},
  {id:'SPEC4',name:'üöÑ Circle Master',line:'Ci',color:'#7B2D8B',stats:{speed:10,crowd:1},ability:'Circle missions auto-win'},
  {id:'H01',name:'Hammersmith Hero',line:'H',color:'#F3A9BB',stats:{speed:6,crowd:5},ability:'West London shortcut'},
  {id:'PAD1',name:'Paddington Bear üêª',line:'Ci',color:'#8B5FB8',stats:{speed:6,crowd:6},ability:'PAD interchange free'},
];

// ============================================================
// GAME STATE
// ============================================================
let gs = {
  oyster:20, deck:[], collection:[], pbs:[], worsts:[],
  streak:0, lastDay:null, wonToday:false, tutorialSeen:false,
  milestones:{}, muted:false, slowMode:false
};

let ms = {
  active:false, start:null, end:null, goal:null,
  playerPath:[], travelling:false, startTime:null,
  elapsed:0, timerInterval:null, playerResult:null,
  direction:null // 'cw' or 'acw'
};

// ============================================================
// SAVE/LOAD
// ============================================================
function save() { try { localStorage.setItem('tubequest_v2', JSON.stringify(gs)); } catch(e){} }
function load() {
  try {
    const d = localStorage.getItem('tubequest_v2');
    if (d) Object.assign(gs, JSON.parse(d));
  } catch(e){}
  const today = new Date().toDateString();
  if (gs.lastDay && gs.lastDay !== today) {
    if (!gs.wonToday) gs.streak = 0;
    gs.wonToday = false;
  }
  gs.lastDay = today;
}

// ============================================================
// AUDIO (WebAudio synth)
// ============================================================
let actx = null;
function getActx() { if (!actx) actx = new (window.AudioContext||window.webkitAudioContext)(); return actx; }
function playSound(type) {
  if (gs.muted) return;
  try {
    const ctx = getActx();
    const osc = ctx.createOscillator(), gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    const t = ctx.currentTime;
    if (type==='spin') {
      osc.type='square'; osc.frequency.setValueAtTime(200,t);
      osc.frequency.exponentialRampToValueAtTime(900,t+0.3);
      gain.gain.setValueAtTime(0.18,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      osc.start(t); osc.stop(t+0.4);
    } else if (type==='ding') {
      osc.type='sine'; osc.frequency.setValueAtTime(880,t);
      osc.frequency.exponentialRampToValueAtTime(1760,t+0.2);
      gain.gain.setValueAtTime(0.28,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.5);
      osc.start(t); osc.stop(t+0.5);
    } else if (type==='cha') {
      osc.type='triangle'; osc.frequency.setValueAtTime(660,t);
      osc.frequency.exponentialRampToValueAtTime(1320,t+0.1);
      gain.gain.setValueAtTime(0.22,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      osc.start(t); osc.stop(t+0.3);
    } else if (type==='buzz') {
      osc.type='sawtooth'; osc.frequency.setValueAtTime(120,t);
      gain.gain.setValueAtTime(0.28,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.7);
      osc.start(t); osc.stop(t+0.7);
    } else if (type==='chug') {
      osc.type='square'; osc.frequency.setValueAtTime(75,t);
      osc.frequency.setValueAtTime(95,t+0.08); osc.frequency.setValueAtTime(75,t+0.16);
      gain.gain.setValueAtTime(0.12,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      osc.start(t); osc.stop(t+0.4);
    }
  } catch(e){}
}

// ============================================================
// MAP DRAWING
// ============================================================
function buildMap() {
  const svg = document.getElementById('tube-map');
  svg.innerHTML = '';

  // Background glow in centre
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  defs.innerHTML = `
    <radialGradient id="centreGlow" cx="50%" cy="48%" r="35%">
      <stop offset="0%" stop-color="#1A2240" stop-opacity="0.6"/>
      <stop offset="100%" stop-color="#0A0E1A" stop-opacity="0"/>
    </radialGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>`;
  svg.appendChild(defs);

  // Centre glow
  const glowBg = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
  glowBg.setAttribute('cx','395'); glowBg.setAttribute('cy','320');
  glowBg.setAttribute('rx','230'); glowBg.setAttribute('ry','185');
  glowBg.setAttribute('fill','url(#centreGlow)');
  svg.appendChild(glowBg);

  // Watermark
  const wm = document.createElementNS('http://www.w3.org/2000/svg','text');
  wm.setAttribute('x','395'); wm.setAttribute('y','335');
  wm.setAttribute('text-anchor','middle'); wm.setAttribute('font-size','100');
  wm.setAttribute('fill','rgba(255,205,0,0.04)');
  wm.setAttribute('font-family','Bebas Neue,sans-serif');
  wm.textContent = 'CIRCLE';
  svg.appendChild(wm);

  // Draw spoke lines FIRST (behind circle)
  Object.entries(spokeStations).forEach(([intId, spokes]) => {
    if (spokes.length === 0) return;
    const intStation = allStations[intId];
    if (!intStation) return;
    spokes.forEach((sp, idx) => {
      const prev = idx === 0 ? intStation : allStations[spokes[idx-1].id];
      const cur = allStations[sp.id];
      if (!prev || !cur) return;
      const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1', prev.pos[0]); ln.setAttribute('y1', prev.pos[1]);
      ln.setAttribute('x2', cur.pos[0]); ln.setAttribute('y2', cur.pos[1]);
      const col = lineColors[sp.line] || '#888';
      ln.setAttribute('stroke', col);
      ln.setAttribute('stroke-width', idx===0 ? '4' : '3');
      ln.setAttribute('stroke-linecap','round');
      ln.setAttribute('opacity', 0.7 - idx*0.15);
      svg.appendChild(ln);
    });
  });

  // Draw Circle line segments
  for (let i = 0; i < circleStations.length - 1; i++) {
    const a = circleStations[i];
    const b = circleStations[i+1];
    if (a.id === 'EDG' && b.id === 'BST') continue; // the gap!
    const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1', a.pos[0]); ln.setAttribute('y1', a.pos[1]);
    ln.setAttribute('x2', b.pos[0]); ln.setAttribute('y2', b.pos[1]);
    ln.setAttribute('stroke', '#FFCD00');
    ln.setAttribute('stroke-width', '5');
    ln.setAttribute('stroke-linecap','round');
    ln.setAttribute('filter','url(#glow)');
    svg.appendChild(ln);
  }
  // Close western arc
  const lastCircle = circleStations[circleStations.length-1]; // PAD2
  const firstCircle = circleStations[0]; // HMD
  const closingLine = document.createElementNS('http://www.w3.org/2000/svg','line');
  closingLine.setAttribute('x1', lastCircle.pos[0]); closingLine.setAttribute('y1', lastCircle.pos[1]);
  closingLine.setAttribute('x2', firstCircle.pos[0]); closingLine.setAttribute('y2', firstCircle.pos[1]);
  closingLine.setAttribute('stroke', '#FFCD00');
  closingLine.setAttribute('stroke-width', '5');
  closingLine.setAttribute('stroke-linecap','round');
  closingLine.setAttribute('filter','url(#glow)');
  svg.appendChild(closingLine);

  // GAP indicator at EDG-BST
  const edg = allStations['EDG'], bst = allStations['BST'];
  const gapMidX = (edg.pos[0]+bst.pos[0])/2;
  const gapMidY = (edg.pos[1]+bst.pos[1])/2;
  const gapTxt = document.createElementNS('http://www.w3.org/2000/svg','text');
  gapTxt.setAttribute('x', gapMidX+5); gapTxt.setAttribute('y', gapMidY-4);
  gapTxt.setAttribute('font-size','9'); gapTxt.setAttribute('fill','rgba(255,205,0,0.5)');
  gapTxt.setAttribute('font-family','Nunito,sans-serif'); gapTxt.setAttribute('font-weight','bold');
  gapTxt.textContent = '‚ö† gap';
  svg.appendChild(gapTxt);

  // Draw all stations
  const allToRender = [...circleStations, ...Object.values(spokeStations).flat()];
  allToRender.forEach(s => {
    const isCircle = circleStations.some(cs=>cs.id===s.id);
    const isInterchange = s.interchange;
    const col = isCircle ? '#FFCD00' : (lineColors[s.line]||'#888');
    const r = isInterchange ? 10 : 7;

    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('id','dot-'+s.id);
    g.setAttribute('class','station-dot');
    g.setAttribute('transform',`translate(${s.pos[0]},${s.pos[1]})`);
    g.style.cursor = 'pointer';

    // Hit area (larger invisible circle for touch)
    const hit = document.createElementNS('http://www.w3.org/2000/svg','circle');
    hit.setAttribute('r','16'); hit.setAttribute('fill','transparent');
    g.appendChild(hit);

    // White border
    if (isInterchange) {
      const border = document.createElementNS('http://www.w3.org/2000/svg','circle');
      border.setAttribute('r', r+3); border.setAttribute('fill','#fff');
      g.appendChild(border);
    }

    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('r', r);
    circle.setAttribute('fill', isCircle ? '#FFCD00' : (isInterchange ? col : '#ccc'));
    circle.setAttribute('stroke', '#0A0E1A');
    circle.setAttribute('stroke-width','1.5');
    g.appendChild(circle);

    g.addEventListener('click', ()=>tapStation(s.id));
    g.addEventListener('touchstart', (e)=>{ e.preventDefault(); tapStation(s.id); }, {passive:false});
    g.addEventListener('mouseenter', ()=>showTooltip(s, g));
    g.addEventListener('mouseleave', hideTooltip);

    svg.appendChild(g);
  });

  // Direction labels
  const cwLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
  cwLabel.setAttribute('x','560'); cwLabel.setAttribute('y','200');
  cwLabel.setAttribute('font-size','11'); cwLabel.setAttribute('fill','rgba(255,205,0,0.4)');
  cwLabel.setAttribute('font-family','Nunito,sans-serif'); cwLabel.setAttribute('font-weight','bold');
  cwLabel.textContent = '‚Üª CLOCKWISE';
  svg.appendChild(cwLabel);

  const acwLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
  acwLabel.setAttribute('x','150'); acwLabel.setAttribute('y','490');
  acwLabel.setAttribute('font-size','11'); acwLabel.setAttribute('fill','rgba(255,205,0,0.4)');
  acwLabel.setAttribute('font-family','Nunito,sans-serif'); acwLabel.setAttribute('font-weight','bold');
  acwLabel.textContent = '‚Ü∫ ANTI-CLOCKWISE';
  svg.appendChild(acwLabel);
}

function showTooltip(s, g) {
  const tt = document.getElementById('station-tooltip');
  const rect = document.getElementById('map-container').getBoundingClientRect();
  const svgEl = document.getElementById('tube-map');
  const vbW=800, vbH=700;
  const scaleX = svgEl.clientWidth/vbW;
  const scaleY = svgEl.clientHeight/vbH;
  tt.textContent = s.name;
  tt.style.left = (s.pos[0]*scaleX)+'px';
  tt.style.top = (s.pos[1]*scaleY)+'px';
  tt.style.display = 'block';
}
function hideTooltip() {
  document.getElementById('station-tooltip').style.display = 'none';
}

// ============================================================
// MAP UPDATE (highlight path)
// ============================================================
function updateMap() {
  // Reset all dots
  document.querySelectorAll('.station-dot').forEach(dot => {
    const id = dot.id.replace('dot-','');
    const s = allStations[id];
    if (!s) return;
    const isCircle = circleStations.some(cs=>cs.id===id);
    const isInterchange = s.interchange;
    const circles = dot.querySelectorAll('circle');
    const mainCircle = circles[circles.length-1];
    if (mainCircle) {
      const col = isCircle ? '#FFCD00' : (lineColors[s.line]||'#888');
      mainCircle.setAttribute('fill', isCircle ? '#FFCD00' : (isInterchange ? col : '#ccc'));
      mainCircle.setAttribute('r', isInterchange ? '10' : '7');
    }
  });

  if (!ms.start) return;

  const markStation = (id, color, r) => {
    const dot = document.getElementById('dot-'+id);
    if (!dot) return;
    const circles = dot.querySelectorAll('circle');
    const mainCircle = circles[circles.length-1];
    if (mainCircle) { mainCircle.setAttribute('fill', color); mainCircle.setAttribute('r', String(r)); }
  };

  markStation(ms.start, '#E11B22', 13);
  markStation(ms.end, '#FF6B35', 13);

  ms.playerPath.forEach((id,i) => {
    if (id !== ms.start && id !== ms.end) {
      markStation(id, '#00C851', 9);
    }
  });

  updatePathDisplay();
  updateFarePreview();
}

// ============================================================
// MISSIONS
// ============================================================
const missionGoals = [
  {text:'Under 25 min', type:'time', value:25},
  {text:'Max 2 changes', type:'changes', value:2},
  {text:'Under ¬£5 fare', type:'fare', value:5},
  {text:'Under 35 min', type:'time', value:35},
  {text:'Max 1 change', type:'changes', value:1},
  {text:'Beat the AI!', type:'ai', value:null},
  {text:'Any route!', type:'any', value:null},
  {text:'Under ¬£4 fare', type:'fare', value:4},
  {text:'Under 20 min', type:'time', value:20},
];

function getOuterStations() {
  return Object.values(spokeStations).flat().map(s=>s.id);
}

function spinMission() {
  if (ms.travelling) return;
  if (gs.oyster < 20) { showEventBrief('üí∏','Not enough Oyster! Need ¬£20'); return; }

  playSound('spin');
  gs.oyster -= 20;
  updateOysterDisplay();
  ms = { active:false, start:null, end:null, goal:null, playerPath:[], travelling:false,
    startTime:null, elapsed:0, timerInterval:null, playerResult:null, direction:null };

  ['reel-start','reel-end','reel-goal'].forEach(r => {
    document.getElementById(r).classList.add('spinning');
    document.getElementById(r).classList.remove('landed');
  });

  const outerStations = getOuterStations();
  const si = setInterval(() => {
    const ts = outerStations[Math.floor(Math.random()*outerStations.length)];
    const te = outerStations[Math.floor(Math.random()*outerStations.length)];
    const tg = missionGoals[Math.floor(Math.random()*missionGoals.length)];
    document.getElementById('reel-start').innerHTML = `üöá<br><span style="font-size:8px">${(allStations[ts]?.name||'?').substring(0,11)}</span>`;
    document.getElementById('reel-end').innerHTML = `üèÅ<br><span style="font-size:8px">${(allStations[te]?.name||'?').substring(0,11)}</span>`;
    document.getElementById('reel-goal').innerHTML = `üéØ<br><span style="font-size:8px">${tg.text.substring(0,12)}</span>`;
  }, 80);

  setTimeout(() => {
    clearInterval(si);
    const outer = getOuterStations();
    let start = outer[Math.floor(Math.random()*outer.length)];
    let end = outer[Math.floor(Math.random()*outer.length)];
    let tries = 0;
    while ((end === start || !bfs(start,end)) && tries++ < 30) {
      start = outer[Math.floor(Math.random()*outer.length)];
      end = outer[Math.floor(Math.random()*outer.length)];
    }
    const goal = missionGoals[Math.floor(Math.random()*missionGoals.length)];

    ms.start = start; ms.end = end; ms.goal = goal;
    ms.active = true; ms.playerPath = [start];

    ['reel-start','reel-end','reel-goal'].forEach(r => {
      document.getElementById(r).classList.remove('spinning');
      document.getElementById(r).classList.add('landed');
    });
    document.getElementById('reel-start').innerHTML = `üöá<br><span style="font-size:8px">${(allStations[start]?.name||'?').substring(0,11)}</span>`;
    document.getElementById('reel-end').innerHTML = `üèÅ<br><span style="font-size:8px">${(allStations[end]?.name||'?').substring(0,11)}</span>`;
    document.getElementById('reel-goal').innerHTML = `üéØ<br><span style="font-size:8px">${goal.text}</span>`;

    playSound('ding');
    updateMissionCard();
    updateMap();
    document.getElementById('build-section').style.display = 'block';
    document.getElementById('build-section-map').style.display = 'block';
    document.getElementById('phase-banner').textContent = 'üó∫Ô∏è TAP YOUR START STATION';
    save();
  }, 1800);
}

function updateMissionCard() {
  if (!ms.start) return;
  document.getElementById('mission-card').innerHTML = `
    <h3>üéØ ACTIVE MISSION</h3>
    <div class="mission-route">${allStations[ms.start]?.name} ‚Üí ${allStations[ms.end]?.name}</div>
    <div class="mission-detail">
      <span class="mission-badge">üéØ ${ms.goal.text}</span>
      <span class="mission-badge">üí∞ ¬£${gs.oyster.toFixed(2)}</span>
    </div>
    <p style="font-size:11px;color:var(--text-dim);margin-top:4px">Enter Circle ‚Üí travel rim ‚Üí exit to destination</p>`;
}

// ============================================================
// STATION TAPPING
// ============================================================
function tapStation(id) {
  if (!ms.active || ms.travelling) return;
  if (id === ms.start && ms.playerPath.length === 1) {
    showEventBrief('üöá', `Start: ${allStations[id]?.name}. Now tap towards the Circle!`);
    return;
  }

  if (ms.playerPath.includes(id)) {
    const idx = ms.playerPath.indexOf(id);
    if (idx > 0) { ms.playerPath = ms.playerPath.slice(0, idx+1); }
  } else {
    // Check adjacency
    const last = ms.playerPath[ms.playerPath.length-1];
    const edge = (graph[last]||[]).find(e=>e.to===id);
    if (!edge) {
      showEventBrief('‚ö†Ô∏è', `${allStations[id]?.name} isn't connected to ${allStations[last]?.name}!`);
      return;
    }
    ms.playerPath.push(id);
  }

  playSound('chug');

  // Show direction picker when entering Circle
  const last = ms.playerPath[ms.playerPath.length-1];
  const onCircle = circleStations.some(cs=>cs.id===last);
  if (onCircle && ms.playerPath.length > 1 && !ms.direction) {
    document.getElementById('direction-picker').style.display = 'block';
    document.getElementById('phase-banner').textContent = '‚Üª PICK DIRECTION ON CIRCLE';
  }

  updateMap();

  const endReached = ms.playerPath[ms.playerPath.length-1] === ms.end;
  document.getElementById('btn-travel').disabled = !endReached;
  if (endReached) {
    document.getElementById('phase-banner').textContent = 'üöÇ READY TO TRAVEL!';
    playSound('ding');
  }
}

function setDirection(dir) {
  ms.direction = dir;
  document.getElementById('dir-cw').classList.toggle('selected', dir==='cw');
  document.getElementById('dir-acw').classList.toggle('selected', dir==='acw');
  document.getElementById('phase-banner').textContent = dir==='cw' ? '‚Üª CLOCKWISE ‚Äî TAP ONWARDS' : '‚Ü∫ ANTI-CLOCK ‚Äî TAP ONWARDS';
}

function undoLastStation() {
  if (ms.playerPath.length > 1) {
    ms.playerPath.pop();
    document.getElementById('btn-travel').disabled = true;
    updateMap();
    // Hide direction picker if no longer on Circle
    const last = ms.playerPath[ms.playerPath.length-1];
    const onCircle = circleStations.some(cs=>cs.id===last);
    if (!onCircle) {
      ms.direction = null;
      document.getElementById('direction-picker').style.display = 'none';
      document.getElementById('dir-cw').classList.remove('selected');
      document.getElementById('dir-acw').classList.remove('selected');
    }
  }
}

function showHint() {
  if (!ms.start || !ms.end) return;
  const opt = bfs(ms.start, ms.end);
  const hb = document.getElementById('hint-box');
  if (opt && opt.path.length > 1) {
    const next = allStations[opt.path[1]]?.name || opt.path[1];
    document.getElementById('hint-text').textContent =
      `Optimal: ${opt.path.length} stops, ~${opt.time}min, ${opt.changes} changes. Next tap: ${next}`;
  } else {
    document.getElementById('hint-text').textContent = 'Build a path from your start through the Circle to your destination!';
  }
  hb.classList.add('show'); hb.style.display = 'block';
  setTimeout(()=>{ hb.style.display='none'; hb.classList.remove('show'); }, 5000);
}

// ============================================================
// FARE/ROUTE CALC
// ============================================================
function calculateRoute(path) {
  let time=0, changes=0, lastLine=null;
  for (let i=0; i<path.length-1; i++) {
    const edge = (graph[path[i]]||[]).find(e=>e.to===path[i+1]);
    const t = edge ? edge.time : 3;
    const line = edge ? edge.line : null;
    if (lastLine && line && lastLine !== line) { changes++; time+=4; }
    time += t;
    lastLine = line || lastLine;
  }
  const active = gs.deck.filter(c=>c.active);
  let timeMod = 0;
  active.forEach(c => {
    const def = cardDefs.find(d=>d.id===c.id);
    if (!def) return;
    if (def.ability.includes('-2min')) timeMod -= 2;
    if (def.ability.includes('-3min')) timeMod -= 3;
    if (def.ability.includes('-1min')) timeMod -= 1;
  });
  time = Math.max(1, time + timeMod);
  if (gs.slowMode) time = Math.round(time * 1.8);

  const startZ = zones[path[0]]||1, endZ = zones[path[path.length-1]]||1;
  const maxZ = Math.max(startZ, endZ);
  let fare = 2.50 + (maxZ-1)*0.5 + changes*1.50;
  if (active.some(c=>c.id==='SPEC2')) fare *= 0.8;
  fare = Math.max(1.50, Math.min(fare, 14));
  return {time, changes, fare: parseFloat(fare.toFixed(2))};
}

function updatePathDisplay() {
  const pd = document.getElementById('path-display');
  if (!pd) return;
  pd.innerHTML = ms.playerPath.map((id,i)=>{
    const line = i>0 ? getEdgeLine(ms.playerPath[i-1],id) : null;
    const col = line ? (lineColors[line]||'#888') : '#888';
    const name = (allStations[id]?.name||id).substring(0,9);
    return `<span class="path-node" style="border-left:3px solid ${col}">
      ${i===0?'üöá':id===ms.end?'üèÅ':'‚óè'} ${name}
    </span>`;
  }).join('');
}

function updateFarePreview() {
  if (ms.playerPath.length < 2) {
    document.getElementById('route-display').textContent = 'Tap stations...';
    document.getElementById('fare-display').textContent = '¬£0.00';
    document.getElementById('time-display').textContent = '0 min';
    document.getElementById('changes-display').textContent = '0';
    return;
  }
  const r = calculateRoute(ms.playerPath);
  document.getElementById('route-display').textContent = `${ms.playerPath.length} stops`;
  document.getElementById('fare-display').textContent = `¬£${r.fare.toFixed(2)}`;
  document.getElementById('time-display').textContent = `${r.time} min`;
  document.getElementById('changes-display').textContent = r.changes;
}

// ============================================================
// TRAVEL
// ============================================================
function startTravel() {
  if (!ms.active || ms.travelling) return;
  if (ms.playerPath[ms.playerPath.length-1] !== ms.end) return;
  const r = calculateRoute(ms.playerPath);
  if (gs.oyster < r.fare) { showEventBrief('üí∏',`Need ¬£${r.fare.toFixed(2)}!`); return; }

  gs.oyster -= r.fare;
  updateOysterDisplay();
  ms.travelling = true;
  ms.startTime = Date.now();
  ms.playerResult = r;
  document.getElementById('phase-banner').textContent = 'üöÇ TRAVELLING...';
  document.getElementById('timer-display').style.display = 'block';
  document.getElementById('direction-picker').style.display = 'none';
  document.getElementById('build-section').style.display = 'none';

  ms.timerInterval = setInterval(()=>{
    ms.elapsed = Math.floor((Date.now()-ms.startTime)/1000);
    const m=Math.floor(ms.elapsed/60), s=ms.elapsed%60;
    document.getElementById('timer-display').textContent = `‚è± ${m}:${s.toString().padStart(2,'0')}`;
  },1000);

  animateTrain();
}

function animateTrain() {
  const path = ms.playerPath;
  const train = document.getElementById('train-marker');
  train.style.display = 'flex';
  let idx = 0;
  const svgEl = document.getElementById('tube-map');
  const mc = document.getElementById('map-container');

  const step = () => {
    if (idx >= path.length) {
      setTimeout(()=>{ train.style.display='none'; finishTravel(); },400);
      return;
    }
    const s = allStations[path[idx]];
    if (s) {
      const vbW=800, vbH=700;
      const scaleX = svgEl.clientWidth/vbW;
      const scaleY = svgEl.clientHeight/vbH;
      train.style.left = (s.pos[0]*scaleX-16)+'px';
      train.style.top = (s.pos[1]*scaleY-9)+'px';
    }
    if (idx > 0 && Math.random() < 0.16) triggerRandomEvent();
    idx++;
    const delay = gs.slowMode ? 1800 : 900;
    setTimeout(step, delay);
  };
  step();
}

function triggerRandomEvent() {
  const hasNinja = gs.deck.some(c=>c.id==='J02'&&c.active);
  const events = [
    {icon:'‚ö†Ô∏è', msg:'Signal failure! +2 min', fn:()=>{ ms.playerResult.time+=2; }},
    {icon:'üòà', msg:'Pickpocket! Lost a card üò±', fn:()=>{
      if (hasNinja) { showEventBrief('üòé','Jubilee Ninja blocked the mugger!'); return; }
      if (gs.collection.length>0) {
        const lost = gs.collection.splice(Math.floor(Math.random()*gs.collection.length),1)[0];
        const d=cardDefs.find(x=>x.id===lost.id);
        document.getElementById('event-msg').textContent=`Lost "${d?.name||'card'}" üò±`;
      }
    }},
    {icon:'üéÅ', msg:'Found a bonus card!', fn:()=>{
      const pool=cardDefs.filter(c=>!gs.collection.some(gc=>gc.id===c.id));
      if(pool.length>0){ const c=pool[Math.floor(Math.random()*pool.length)]; addCard(c.id);
        document.getElementById('event-msg').textContent=`Found: ${c.name}!`; }
    }},
    {icon:'‚ö°', msg:'Express service! -1 min', fn:()=>{ ms.playerResult.time=Math.max(1,ms.playerResult.time-1); }},
    {icon:'üçÇ', msg:'Leaf on the line... +3 min', fn:()=>{ ms.playerResult.time+=3; }},
  ];
  const ev = events[Math.floor(Math.random()*events.length)];
  ev.fn();
  showEventBrief(ev.icon, ev.msg);
  playSound('buzz');
}

function showEventBrief(icon, msg) {
  document.getElementById('event-icon').textContent = icon;
  document.getElementById('event-msg').textContent = msg;
  document.getElementById('event-popup').classList.add('show');
  setTimeout(()=>document.getElementById('event-popup').classList.remove('show'), 2600);
}
function dismissEvent() { document.getElementById('event-popup').classList.remove('show'); }

// ============================================================
// FINISH TRAVEL
// ============================================================
function finishTravel() {
  clearInterval(ms.timerInterval);
  document.getElementById('timer-display').style.display = 'none';
  const result = ms.playerResult;
  const goal = ms.goal;

  let goalMet = false;
  if (goal.type==='time') goalMet = result.time <= goal.value;
  else if (goal.type==='changes') goalMet = result.changes <= goal.value;
  else if (goal.type==='fare') goalMet = result.fare <= goal.value;
  else if (goal.type==='any') goalMet = true;
  else if (goal.type==='ai') {
    const ai = bfs(ms.start, ms.end);
    if (ai) { const air = calculateRoute(ai.path); goalMet = result.time <= air.time; }
    else goalMet = true;
  }

  const score = Math.max(1, Math.round((result.time*(result.changes+1)*result.fare)/10));
  const wonCards = [];
  if (goalMet) {
    const pool = cardDefs.filter(c=>!gs.collection.some(gc=>gc.id===c.id));
    if (pool.length>0) { const c=pool[Math.floor(Math.random()*pool.length)]; wonCards.push(c); addCard(c.id); }
    gs.oyster += 5; updateOysterDisplay(); playSound('cha');
    gs.streak++; gs.wonToday=true;
  } else {
    playSound('buzz');
  }

  const routeKey = `${allStations[ms.start]?.name}‚Üí${allStations[ms.end]?.name}`;
  let isPB = false;
  const existing = gs.pbs.find(p=>p.route===routeKey);
  if (!existing || score < existing.score) {
    gs.pbs = gs.pbs.filter(p=>p.route!==routeKey);
    gs.pbs.push({route:routeKey, score, time:result.time});
    gs.pbs.sort((a,b)=>a.score-b.score);
    if (gs.pbs.length>10) gs.pbs=gs.pbs.slice(0,10);
    isPB = true;
  }
  gs.worsts.push({route:routeKey, score, time:result.time});
  gs.worsts.sort((a,b)=>b.score-a.score);
  if (gs.worsts.length>5) gs.worsts=gs.worsts.slice(0,5);

  checkMilestones();
  save();
  showResult(goalMet, score, result, wonCards, isPB);
  ms.active=false; ms.travelling=false;
  document.getElementById('phase-banner').textContent='üé∞ SPIN TO START';
  document.getElementById('build-section-map').style.display='none';
}

function addCard(id) {
  if (gs.collection.some(c=>c.id===id)) { gs.oyster+=2; updateOysterDisplay(); return; }
  const active = gs.collection.filter(c=>c.active).length;
  gs.collection.push({id, active: active<5});
  gs.deck = [...gs.collection];
}

// ============================================================
// RESULT
// ============================================================
function showResult(won, score, result, wonCards, isPB) {
  document.getElementById('result-screen').classList.remove('hidden');
  document.getElementById('result-title').textContent = won ? 'üèÜ MISSION COMPLETE!' : 'üíÄ MISSION FAILED!';
  document.getElementById('result-title').style.color = won ? 'var(--gold)' : 'var(--tfl-red)';
  document.getElementById('result-score').textContent = score;
  document.getElementById('result-time').textContent = `‚è± ${result.time} min`;
  document.getElementById('result-changes').textContent = `üîÑ Changes: ${result.changes}`;
  document.getElementById('result-fare').textContent = `üí∞ Fare: ¬£${result.fare.toFixed(2)}`;
  document.getElementById('result-oyster').textContent = `üÉè Oyster: ¬£${gs.oyster.toFixed(2)}`;
  document.getElementById('result-pb').textContent = isPB ? 'üèÖ NEW PERSONAL BEST!' : (won?'üéØ Goal achieved!':'üí® Try again!');
  document.getElementById('result-cards').innerHTML = wonCards.length>0
    ? wonCards.map(c=>`<div class="tube-card" style="width:85px;background:linear-gradient(135deg,${c.color}AA,${c.color}33)">
        <div class="card-line" style="color:${c.color}">${c.line}</div>
        <div class="card-name">${c.name}</div>
        <div class="card-stats">‚ö°${c.stats.speed}</div>
        <div class="card-ability">${c.ability}</div></div>`).join('')
    : '<p style="color:var(--text-dim);font-size:13px">No cards this run</p>';
  if (won) playSound('ding');
}
function closeResult() {
  document.getElementById('result-screen').classList.add('hidden');
  renderCards(); updateScoresTab(); renderGallery(); updateOysterDisplay();
}

// ============================================================
// CARDS
// ============================================================
function renderCards() {
  const dg = document.getElementById('deck-grid');
  const cg = document.getElementById('collection-grid');
  dg.innerHTML=''; cg.innerHTML='';
  gs.collection.forEach(c=>{
    const def = cardDefs.find(d=>d.id===c.id);
    if (!def) return;
    const el = document.createElement('div');
    el.className='tube-card'+(c.active?' selected':'');
    el.style.background=`linear-gradient(135deg,${def.color}AA,${def.color}33)`;
    el.innerHTML=`<div class="card-line" style="color:${def.color}">${def.line}</div>
      <div class="card-name">${def.name}</div>
      <div class="card-stats">‚ö°${def.stats.speed} üë•${def.stats.crowd}</div>
      <div class="card-ability">${def.ability}</div>
      ${c.active?'<div style="color:var(--gold);font-size:9px;margin-top:3px">‚òÖ ACTIVE</div>':''}`;
    el.onclick=()=>{ toggleCard(c); };
    if (c.active) dg.appendChild(el.cloneNode(true));
    cg.appendChild(el);
  });
  dg.querySelectorAll('.tube-card').forEach((el,i)=>{
    const card = gs.collection.filter(c=>c.active)[i];
    if (card) el.onclick=()=>toggleCard(card);
  });
}
function toggleCard(card) {
  if (card.active) { card.active=false; }
  else {
    const active = gs.collection.filter(c=>c.active);
    if (active.length>=5) active[0].active=false;
    card.active=true;
  }
  playSound('chug'); renderCards(); save();
}

// ============================================================
// SCORES / GALLERY
// ============================================================
function updateScoresTab() {
  document.getElementById('pb-tbody').innerHTML = gs.pbs.map(p=>
    `<tr><td>${p.route}</td><td>${p.score}</td><td>${p.time}</td></tr>`).join('')
    || '<tr><td colspan="3" style="color:var(--text-dim)">No runs yet!</td></tr>';
  document.getElementById('worst-tbody').innerHTML = gs.worsts.map(p=>
    `<tr><td>${p.route}</td><td>${p.score}</td><td>${p.time}</td></tr>`).join('')
    || '<tr><td colspan="3" style="color:var(--text-dim)">No runs yet!</td></tr>';
  renderMilestoneBadges();
}
const milestoneDefs = [
  {id:'streak3', name:'3-Win Streak',  icon:'üî•', check:()=>gs.streak>=3},
  {id:'collector',name:'5 Cards',      icon:'üÉè', check:()=>gs.collection.length>=5},
  {id:'bargain',  name:'Budget Hero',  icon:'üí∏', check:()=>(gs.milestones.cheap_wins||0)>=2},
  {id:'speedster',name:'Speed Demon',  icon:'‚ö°', check:()=>(gs.milestones.fast_wins||0)>=1},
  {id:'streak5',  name:'5-Win Streak', icon:'üí•', check:()=>gs.streak>=5},
  {id:'tenner',   name:'10 Cards',     icon:'üåü', check:()=>gs.collection.length>=10},
];
function checkMilestones() {
  milestoneDefs.forEach(m=>{
    if (!gs.milestones['done_'+m.id] && m.check()) {
      gs.milestones['done_'+m.id]=true;
      showEventBrief('üèÖ','Achievement: '+m.name+'!');
    }
  });
}
function renderMilestoneBadges() {
  const el = document.getElementById('milestones-area');
  if (el) el.innerHTML = milestoneDefs.filter(m=>gs.milestones['done_'+m.id])
    .map(m=>`<div class="milestone-badge">${m.icon} ${m.name}</div>`).join('');
  const ml = document.getElementById('milestone-list');
  if (ml) ml.innerHTML = milestoneDefs.map(m=>{
    const done=gs.milestones['done_'+m.id];
    return `<div class="milestone-badge" style="${done?'':'background:var(--surface2);color:var(--text-dim)'}">
      ${m.icon} ${m.name} ${done?'‚úì':'üîí'}</div>`;}).join('');
}
function renderGallery() {
  const gg=document.getElementById('gallery-grid');
  const gc=document.getElementById('gallery-count');
  const gp=document.getElementById('gallery-progress');
  const owned=gs.collection.length, total=cardDefs.length;
  if(gc) gc.textContent=owned;
  if(gp) gp.style.width=`${(owned/total)*100}%`;
  if(!gg) return;
  gg.innerHTML='';
  cardDefs.forEach(def=>{
    const has=gs.collection.some(c=>c.id===def.id);
    const el=document.createElement('div');
    if(has){
      el.className='tube-card';
      el.style.background=`linear-gradient(135deg,${def.color}AA,${def.color}33)`;
      el.innerHTML=`<div class="card-line" style="color:${def.color}">${def.line}</div>
        <div class="card-name" style="font-size:9px">${def.name}</div>
        <div class="card-stats">‚ö°${def.stats.speed}</div>`;
    } else {
      el.className='gallery-slot'; el.innerHTML='?';
    }
    gg.appendChild(el);
  });
}
function renderMarket() {
  const ma=document.getElementById('market-area');
  if(!ma) return;
  const avail=cardDefs.filter(c=>!gs.collection.some(gc=>gc.id===c.id)).slice(0,4);
  if(!avail.length){ma.innerHTML='<p style="color:var(--text-dim);font-size:13px">All cards collected!</p>';return;}
  ma.innerHTML=avail.map(c=>{
    const price=6+cardDefs.indexOf(c)%5;
    return `<div class="market-card" onclick="buyCard('${c.id}')">
      <div style="width:36px;height:44px;border-radius:8px;background:${c.color};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff">${c.line}</div>
      <div class="market-card-info"><h4>${c.name}</h4><p>${c.ability}</p></div>
      <div class="market-price">¬£${price}</div></div>`; }).join('');
}
function buyCard(id) {
  const def=cardDefs.find(d=>d.id===id);
  if(!def) return;
  const price=6+cardDefs.indexOf(def)%5;
  if(gs.oyster<price){showEventBrief('üí∏',`Need ¬£${price}!`);return;}
  gs.oyster-=price; addCard(id); updateOysterDisplay();
  renderCards(); renderGallery(); renderMarket(); save(); playSound('cha');
  showEventBrief('üÉè',`Bought ${def.name}!`);
}

// ============================================================
// SHARE
// ============================================================
function shareChallenge() {
  if(!ms.start){showEventBrief('‚ö†Ô∏è','Spin a mission first!');return;}
  const seed=btoa(`${ms.start}-${ms.end}-${ms.goal.type}`);
  const url=`${window.location.href.split('?')[0]}?seed=${seed}`;
  const sc=document.getElementById('share-code');
  sc.innerHTML=`<div style="background:var(--surface2);border-radius:8px;padding:8px;font-size:11px;word-break:break-all;margin-bottom:6px">${url}</div>
    <button class="btn-small btn-secondary" onclick="navigator.clipboard.writeText('${url}').then(()=>showEventBrief('üìã','Copied!'))">üìã Copy</button>`;
}
function shareResult() {
  const txt=`üöá Tube Quest!\nScore: ${document.getElementById('result-score').textContent}\n${document.getElementById('result-time').textContent}\n${document.getElementById('result-fare').textContent}\nüî• Streak: ${gs.streak}\n${window.location.href}`;
  if(navigator.share) navigator.share({title:'Tube Quest',text:txt}).catch(()=>{});
  else navigator.clipboard.writeText(txt).then(()=>showEventBrief('üìã','Copied!')).catch(()=>{});
}

// ============================================================
// UI HELPERS
// ============================================================
function updateOysterDisplay() {
  document.getElementById('oyster-display').textContent=`üÉè ¬£${gs.oyster.toFixed(2)}`;
  document.getElementById('streak-display').textContent=`üî• ${gs.streak}`;
  const oc=document.getElementById('oyster-display');
  oc.style.background=gs.oyster<5?'var(--tfl-red)':'var(--oyster-teal)';
  oc.style.color=gs.oyster<5?'#fff':'#000';
  if(gs.oyster<3){gs.oyster+=20;showEventBrief('üí≥','Auto top-up! +¬£20');updateOysterDisplay();save();}
}
function showTab(name) {
  ['game','cards','scores','gallery'].forEach(t=>{
    document.getElementById(`tab-content-${t}`).style.display=t===name?'block':'none';
    document.getElementById(`tab-${t}`).classList.toggle('active',t===name);
  });
  if(name==='cards') renderCards();
  if(name==='scores') updateScoresTab();
  if(name==='gallery'){renderGallery();renderMarket();}
}
function closeTutorial(){
  document.getElementById('modal-overlay').classList.add('hidden');
  gs.tutorialSeen=true; save();
}

// ============================================================
// CONTROLS
// ============================================================
document.getElementById('btn-mute').addEventListener('click',()=>{
  gs.muted=!gs.muted;
  document.getElementById('btn-mute').textContent=gs.muted?'üîá':'üîä'; save();
});
document.getElementById('btn-slow').addEventListener('click',()=>{
  gs.slowMode=!gs.slowMode;
  const b=document.getElementById('btn-slow');
  b.style.background=gs.slowMode?'var(--oyster-teal)':'var(--surface2)';
  b.style.color=gs.slowMode?'#000':'var(--text)';
  showEventBrief(gs.slowMode?'üê¢':'üêá',gs.slowMode?'Slow Mode ON':'Slow Mode OFF'); save();
});
document.getElementById('btn-fullscreen').addEventListener('click',()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen().catch(()=>{});
});

// Pinch/pan basic support
let mapScale=1, mapOffX=0, mapOffY=0, isPanning=false, panStart={x:0,y:0};
const mc=document.getElementById('map-container');
mc.addEventListener('wheel',(e)=>{
  e.preventDefault();
  mapScale = Math.max(0.8,Math.min(3, mapScale-(e.deltaY*0.001)));
  applyMapTransform();
},{passive:false});
mc.addEventListener('mousedown',(e)=>{
  if(e.target.closest('.station-dot')) return;
  isPanning=true; panStart={x:e.clientX-mapOffX, y:e.clientY-mapOffY};
});
mc.addEventListener('mousemove',(e)=>{
  if(!isPanning) return;
  mapOffX=e.clientX-panStart.x; mapOffY=e.clientY-panStart.y;
  applyMapTransform();
});
mc.addEventListener('mouseup',()=>isPanning=false);
mc.addEventListener('mouseleave',()=>isPanning=false);

let lastTouchDist=0;
mc.addEventListener('touchstart',(e)=>{
  if(e.touches.length===2){
    lastTouchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  }
},{passive:true});
mc.addEventListener('touchmove',(e)=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    mapScale=Math.max(0.8,Math.min(3,mapScale*(dist/lastTouchDist)));
    lastTouchDist=dist;
    applyMapTransform();
  }
},{passive:false});
function applyMapTransform(){
  document.getElementById('tube-map').style.transform=`translate(${mapOffX}px,${mapOffY}px) scale(${mapScale})`;
  document.getElementById('tube-map').style.transformOrigin='center center';
}

// ============================================================
// URL SEED
// ============================================================
function checkURLSeed(){
  const seed=new URLSearchParams(window.location.search).get('seed');
  if(!seed) return;
  try {
    const [start,end,gtype]=atob(seed).split('-');
    if(allStations[start]&&allStations[end]){
      ms.start=start; ms.end=end; ms.goal=missionGoals.find(g=>g.type===gtype)||missionGoals[0];
      ms.active=true; ms.playerPath=[start];
      gs.oyster-=20; updateOysterDisplay(); updateMissionCard(); updateMap();
      document.getElementById('build-section').style.display='block';
      document.getElementById('build-section-map').style.display='block';
      document.getElementById('phase-banner').textContent='üéØ CHALLENGE LOADED!';
      showEventBrief('üéØ',"Friend's challenge loaded!");
    }
  }catch(e){}
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('load',()=>{
  load();
  buildGraph();
  buildMap();
  updateOysterDisplay();
  renderCards(); updateScoresTab(); renderGallery();
  if(gs.muted) document.getElementById('btn-mute').textContent='üîá';
  if(gs.slowMode){
    const b=document.getElementById('btn-slow');
    b.style.background='var(--oyster-teal)'; b.style.color='#000';
  }
  checkURLSeed();
  setTimeout(()=>{
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='flex';
    if(!gs.tutorialSeen) document.getElementById('modal-overlay').classList.remove('hidden');
  },1000);
});
</script>
</body>
</html>
