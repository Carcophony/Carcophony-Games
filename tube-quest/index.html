<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üöá Tube Quest: Commuter Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
:root {
  --tfl-red: #E11B22;
  --tfl-navy: #0019A8;
  --tfl-blue: #00A3E0;
  --elizabeth: #603A9E;
  --oyster-teal: #00B2A9;
  --bg: #0A0E1A;
  --surface: #131929;
  --surface2: #1E2A40;
  --card-bg: #1A2035;
  --text: #F0F4FF;
  --text-dim: #8899BB;
  --gold: #FFD700;
  --green: #00C851;
  --warn: #FF6B35;
  --font-h: 'Bebas Neue', sans-serif;
  --font-b: 'Nunito', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font-b);}
#app{width:100vw;height:100vh;display:flex;flex-direction:column;overflow:hidden;position:relative;}

/* HEADER */
#header{
  background:linear-gradient(135deg,#0A0E1A 0%,#131929 100%);
  border-bottom:3px solid var(--tfl-red);
  padding:8px 12px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
  z-index:10;
}
#header h1{font-family:var(--font-h);font-size:clamp(22px,5vw,36px);letter-spacing:2px;
  background:linear-gradient(90deg,var(--tfl-red),var(--oyster-teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#oyster-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.oyster-chip{background:var(--oyster-teal);color:#000;border-radius:20px;padding:4px 12px;
  font-size:clamp(14px,3vw,20px);font-weight:900;}
.streak-chip{background:var(--warn);color:#fff;border-radius:20px;padding:4px 10px;
  font-size:clamp(12px,2.5vw,18px);font-weight:900;}
#btn-fullscreen,#btn-mute,#btn-slow{
  background:var(--surface2);border:2px solid var(--text-dim);color:var(--text);
  border-radius:10px;padding:6px 10px;font-size:20px;cursor:pointer;
  transition:all 0.2s;
}
#btn-fullscreen:hover,#btn-mute:hover,#btn-slow:hover{border-color:var(--oyster-teal);transform:scale(1.1);}

/* MAIN */
#main{flex:1;display:flex;overflow:hidden;position:relative;}

/* LEFT PANEL */
#left-panel{
  width:clamp(280px,35vw,420px);
  background:var(--surface);
  border-right:2px solid var(--surface2);
  display:flex;flex-direction:column;
  overflow:hidden;flex-shrink:0;
}
#tabs{display:flex;border-bottom:2px solid var(--surface2);}
.tab{flex:1;padding:10px 4px;text-align:center;font-family:var(--font-h);
  font-size:clamp(13px,2.5vw,20px);letter-spacing:1px;cursor:pointer;
  transition:all 0.2s;border-bottom:3px solid transparent;background:none;border-top:none;border-left:none;border-right:none;
  color:var(--text-dim);}
.tab.active{color:var(--text);border-bottom-color:var(--oyster-teal);}
.tab:hover{color:var(--text);}
#panel-content{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch;}
#panel-content::-webkit-scrollbar{width:4px;}
#panel-content::-webkit-scrollbar-track{background:var(--surface);}
#panel-content::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:2px;}

/* RIGHT PANEL - MAP + GAME */
#right-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#map-container{flex:1;position:relative;overflow:hidden;}
#tube-map{width:100%;height:100%;}
#game-overlay{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(0deg,var(--bg) 0%,rgba(10,14,26,0.95) 70%,transparent 100%);
  padding:12px;
}

/* MISSION CARD */
.mission-card{
  background:var(--surface2);border:2px solid var(--tfl-navy);border-radius:16px;
  padding:12px;margin-bottom:10px;
}
.mission-card h3{font-family:var(--font-h);font-size:clamp(16px,3vw,24px);letter-spacing:1px;
  color:var(--oyster-teal);margin-bottom:6px;}
.mission-detail{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
.mission-badge{background:var(--surface);border-radius:8px;padding:4px 10px;
  font-size:clamp(12px,2vw,16px);font-weight:700;}
.mission-route{font-size:clamp(14px,2.5vw,20px);font-weight:900;
  background:linear-gradient(90deg,var(--tfl-red),var(--elizabeth));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* SLOT MACHINE */
#slots{
  background:var(--surface2);border:3px solid var(--gold);border-radius:20px;
  padding:12px;margin-bottom:10px;
}
#slots h3{font-family:var(--font-h);font-size:clamp(18px,3.5vw,28px);letter-spacing:2px;
  color:var(--gold);text-align:center;margin-bottom:10px;}
#reels{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.reel{
  width:clamp(70px,18vw,100px);height:clamp(50px,10vh,70px);
  background:var(--surface);border:2px solid var(--text-dim);border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
  font-size:clamp(11px,2vw,16px);font-weight:900;text-align:center;
  transition:all 0.3s;
}
.reel.spinning{animation:reelSpin 0.15s linear infinite;}
.reel.landed{border-color:var(--gold);animation:reelLand 0.3s ease-out;}
@keyframes reelSpin{0%{transform:translateY(-4px);}50%{transform:translateY(4px);}100%{transform:translateY(-4px);}}
@keyframes reelLand{0%{transform:scale(1.15);}100%{transform:scale(1);}}
.reel-label{font-size:clamp(9px,1.5vw,12px);color:var(--text-dim);text-align:center;margin-bottom:2px;}

/* BIG BUTTONS */
.btn-big{
  width:100%;padding:clamp(12px,3vh,20px) 16px;
  border-radius:14px;border:none;cursor:pointer;
  font-family:var(--font-h);font-size:clamp(18px,4vw,30px);
  letter-spacing:2px;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:8px;
  touch-action:manipulation;
}
.btn-big:active{transform:scale(0.96);}
.btn-spin{background:linear-gradient(135deg,var(--gold),#FF8C00);color:#000;}
.btn-spin:hover{filter:brightness(1.1);}
.btn-build{background:linear-gradient(135deg,var(--tfl-navy),var(--tfl-blue));color:#fff;}
.btn-travel{background:linear-gradient(135deg,#00A86B,#00C851);color:#fff;}
.btn-travel:disabled{background:#333;color:#666;cursor:not-allowed;}
.btn-warn{background:linear-gradient(135deg,var(--warn),#FF4444);color:#fff;}
.btn-secondary{background:var(--surface2);color:var(--text);border:2px solid var(--text-dim);}
.btn-hint{background:linear-gradient(135deg,var(--elizabeth),#9B59B6);color:#fff;}
.btn-undo{background:linear-gradient(135deg,#666,#888);color:#fff;}
.btn-small{
  padding:8px 14px;border-radius:10px;border:none;cursor:pointer;
  font-family:var(--font-b);font-size:clamp(13px,2.5vw,18px);font-weight:900;
  transition:all 0.2s;touch-action:manipulation;
}
.btn-small:active{transform:scale(0.95);}
#btn-row{display:flex;gap:8px;flex-wrap:wrap;}

/* CARDS */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(clamp(80px,15vw,120px),1fr));gap:8px;}
.tube-card{
  border-radius:12px;padding:8px;cursor:pointer;
  transition:all 0.3s;position:relative;overflow:hidden;
  border:2px solid rgba(255,255,255,0.15);
  background:var(--card-bg);
}
.tube-card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,0.4);}
.tube-card.selected{border-color:var(--gold);box-shadow:0 0 12px var(--gold);}
.tube-card .card-line{font-family:var(--font-h);font-size:18px;letter-spacing:1px;}
.tube-card .card-name{font-size:clamp(9px,1.5vw,12px);font-weight:900;margin:4px 0;line-height:1.2;}
.tube-card .card-stats{font-size:clamp(8px,1.3vw,11px);color:rgba(255,255,255,0.7);}
.tube-card .card-ability{font-size:clamp(7px,1.2vw,10px);color:rgba(255,255,255,0.6);
  font-style:italic;margin-top:3px;line-height:1.2;}
.card-flip{animation:cardFlip 0.6s ease-in-out;}
@keyframes cardFlip{0%{transform:rotateY(0);}50%{transform:rotateY(90deg);opacity:0;}
  51%{transform:rotateY(-90deg);}100%{transform:rotateY(0);opacity:1;}}

/* PB TABLE */
.pb-table{width:100%;border-collapse:collapse;font-size:clamp(11px,2vw,15px);}
.pb-table th{background:var(--surface2);padding:8px;text-align:left;font-family:var(--font-h);
  font-size:clamp(12px,2vw,16px);letter-spacing:1px;border-bottom:2px solid var(--tfl-red);}
.pb-table td{padding:6px 8px;border-bottom:1px solid var(--surface2);}
.pb-table tr:hover td{background:var(--surface2);}

/* STATION DOTS ON MAP */
.station-dot{cursor:pointer;transition:all 0.2s;}
.station-dot:hover circle{r:8;}
.station-dot.selected circle{fill:var(--gold)!important;r:9;}
.station-dot.on-path circle{fill:var(--green)!important;}
.station-dot.start-station circle{fill:var(--tfl-red)!important;r:10;}
.station-dot.end-station circle{fill:var(--warn)!important;r:10;}

/* TRAIN ANIMATION */
#train-marker{
  position:absolute;width:36px;height:20px;
  background:var(--tfl-red);border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;z-index:20;
  box-shadow:0 0 12px rgba(225,27,34,0.8);
  transition:left 0.8s ease-in-out, top 0.8s ease-in-out;
  pointer-events:none;
}

/* EVENT POPUP */
#event-popup{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0);
  background:var(--surface2);border:3px solid var(--gold);border-radius:20px;
  padding:20px 28px;text-align:center;z-index:50;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  min-width:200px;
}
#event-popup.show{transform:translate(-50%,-50%) scale(1);}
#event-popup h2{font-family:var(--font-h);font-size:clamp(20px,5vw,36px);margin-bottom:8px;}
#event-popup p{font-size:clamp(14px,2.5vw,20px);margin-bottom:12px;}

/* MODAL */
#modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
#modal-overlay.hidden{display:none;}
#modal-box{
  background:var(--surface);border:3px solid var(--tfl-red);border-radius:20px;
  padding:20px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;
}
#modal-box h2{font-family:var(--font-h);font-size:clamp(22px,5vw,36px);letter-spacing:2px;
  color:var(--tfl-red);margin-bottom:12px;}
#modal-box p{font-size:clamp(14px,2.5vw,18px);line-height:1.6;margin-bottom:10px;color:var(--text-dim);}
#modal-box .highlight{color:var(--text);font-weight:900;}
.modal-step{background:var(--surface2);border-radius:12px;padding:10px 14px;margin-bottom:8px;
  font-size:clamp(14px,2.5vw,18px);line-height:1.5;}
.modal-step em{color:var(--oyster-teal);font-style:normal;font-weight:900;}

/* WIN/LOSE */
#result-screen{
  position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:90;
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
#result-screen.hidden{display:none;}
#result-box{
  background:var(--surface);border:4px solid var(--gold);border-radius:24px;
  padding:24px;max-width:480px;width:100%;text-align:center;
}
#result-box h2{font-family:var(--font-h);font-size:clamp(28px,7vw,48px);letter-spacing:3px;margin-bottom:8px;}
.result-stat{font-size:clamp(16px,3vw,22px);margin:6px 0;font-weight:700;}
.result-score{font-family:var(--font-h);font-size:clamp(40px,10vw,72px);color:var(--gold);}
.result-cards{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0;}

/* GALLERY */
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px;}
.gallery-slot{aspect-ratio:0.7;border-radius:10px;background:var(--surface2);
  border:2px dashed var(--text-dim);display:flex;align-items:center;justify-content:center;
  font-size:24px;color:var(--text-dim);}

/* PHASE INDICATORS */
#phase-banner{
  position:absolute;top:8px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.85);border:2px solid var(--oyster-teal);border-radius:12px;
  padding:6px 16px;font-family:var(--font-h);font-size:clamp(14px,3vw,22px);
  letter-spacing:2px;color:var(--oyster-teal);z-index:15;pointer-events:none;
  transition:all 0.3s;
}

/* TIMER */
#timer-display{
  position:absolute;top:8px;right:8px;
  background:rgba(0,0,0,0.85);border:2px solid var(--tfl-red);border-radius:12px;
  padding:6px 14px;font-family:var(--font-h);font-size:clamp(20px,4vw,32px);
  color:var(--tfl-red);z-index:15;letter-spacing:2px;
}

/* FARE PREVIEW */
#fare-preview{
  background:var(--surface);border:2px solid var(--elizabeth);border-radius:12px;
  padding:10px;margin:8px 0;
  font-size:clamp(13px,2.5vw,18px);
}
#fare-preview strong{color:var(--elizabeth);}

/* PROGRESS BAR */
.progress-bar{background:var(--surface2);border-radius:99px;height:8px;overflow:hidden;margin:4px 0;}
.progress-fill{height:100%;border-radius:99px;transition:width 0.5s ease;
  background:linear-gradient(90deg,var(--oyster-teal),var(--tfl-blue));}

/* SCROLL HINT */
.scroll-fade{background:linear-gradient(180deg,transparent,var(--surface));
  height:20px;position:sticky;bottom:0;pointer-events:none;}

/* MARKET */
.market-card{background:var(--surface2);border-radius:14px;padding:10px;margin-bottom:8px;
  display:flex;align-items:center;gap:10px;border:2px solid transparent;cursor:pointer;
  transition:all 0.2s;}
.market-card:hover{border-color:var(--gold);}
.market-card-info{flex:1;}
.market-card-info h4{font-size:clamp(13px,2.5vw,18px);font-weight:900;}
.market-card-info p{font-size:clamp(11px,2vw,14px);color:var(--text-dim);}
.market-price{font-family:var(--font-h);font-size:clamp(16px,3vw,24px);color:var(--gold);}

/* PATH DISPLAY */
.path-node{display:inline-flex;align-items:center;gap:4px;margin:2px;
  background:var(--surface2);border-radius:8px;padding:3px 8px;
  font-size:clamp(10px,1.8vw,14px);font-weight:900;}

/* MILESTONE BADGE */
.milestone-badge{
  background:linear-gradient(135deg,var(--gold),#FF8C00);color:#000;
  border-radius:12px;padding:8px 12px;margin-bottom:8px;
  font-size:clamp(12px,2vw,16px);font-weight:900;
  display:flex;align-items:center;gap:8px;
}

/* HINT BOX */
#hint-box{
  background:var(--surface2);border:2px solid var(--elizabeth);border-radius:12px;
  padding:10px;margin:8px 0;font-size:clamp(13px,2vw,17px);
  display:none;
}
#hint-box.show{display:block;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}

/* MOBILE PORTRAIT HANDLING */
@media(max-width:600px){
  #left-panel{width:100%;border-right:none;border-bottom:2px solid var(--surface2);
    max-height:50vh;min-height:0;}
  #main{flex-direction:column;}
  #map-container{min-height:200px;}
}
@media(orientation:landscape) and (max-height:500px){
  #header{padding:4px 8px;}
  #header h1{font-size:20px;}
}

/* ACCESSIBILITY */
.sr-only{position:absolute;left:-9999px;}
button:focus-visible{outline:3px solid var(--oyster-teal);outline-offset:2px;}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
#loading h1{font-family:var(--font-h);font-size:clamp(32px,8vw,60px);letter-spacing:4px;
  background:linear-gradient(90deg,var(--tfl-red),var(--elizabeth));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.loading-bar{width:200px;height:6px;background:var(--surface2);border-radius:99px;overflow:hidden;}
.loading-fill{height:100%;background:linear-gradient(90deg,var(--tfl-red),var(--oyster-teal));
  animation:loadPulse 1.2s ease-in-out infinite;}
@keyframes loadPulse{0%{width:0%;margin-left:0;}50%{width:70%;margin-left:15%;}100%{width:0%;margin-left:100%;}}
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
  <h1>üöá TUBE QUEST</h1>
  <p style="font-size:18px;color:var(--text-dim)">Loading the Underground...</p>
  <div class="loading-bar"><div class="loading-fill"></div></div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <!-- Header -->
  <div id="header">
    <h1>üöá TUBE QUEST</h1>
    <div id="oyster-bar">
      <div class="oyster-chip" id="oyster-display">üÉè ¬£20.00</div>
      <div class="streak-chip" id="streak-display">üî• 0</div>
      <button class="btn-secondary btn-small" id="btn-slow" title="Slow Mode">üê¢</button>
      <button class="btn-secondary btn-small" id="btn-mute" title="Mute Sounds">üîä</button>
      <button class="btn-secondary btn-small" id="btn-fullscreen" title="Fullscreen">‚õ∂</button>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <!-- LEFT PANEL -->
    <div id="left-panel">
      <div id="tabs">
        <button class="tab active" onclick="showTab('game')" id="tab-game">üéÆ PLAY</button>
        <button class="tab" onclick="showTab('cards')" id="tab-cards">üÉè DECK</button>
        <button class="tab" onclick="showTab('scores')" id="tab-scores">üèÜ SCORES</button>
        <button class="tab" onclick="showTab('gallery')" id="tab-gallery">üìñ GALLERY</button>
      </div>
      <div id="panel-content">
        <!-- GAME TAB -->
        <div id="tab-content-game">
          <!-- Mission -->
          <div id="mission-card" class="mission-card">
            <h3>üé∞ SPIN FOR MISSION</h3>
            <p style="color:var(--text-dim);font-size:14px">Press SPIN to begin your Tube Quest!</p>
          </div>

          <!-- Slots -->
          <div id="slots">
            <h3>üé∞ MISSION SLOT</h3>
            <div id="reels">
              <div>
                <div class="reel-label">START</div>
                <div class="reel" id="reel-start">üöá<br><span style="font-size:10px">???</span></div>
              </div>
              <div>
                <div class="reel-label">END</div>
                <div class="reel" id="reel-end">üèÅ<br><span style="font-size:10px">???</span></div>
              </div>
              <div>
                <div class="reel-label">GOAL</div>
                <div class="reel" id="reel-goal">üéØ<br><span style="font-size:10px">???</span></div>
              </div>
            </div>
            <button class="btn-big btn-spin" id="btn-spin" onclick="spinMission()">
              üé∞ SPIN! (¬£20 BET)
            </button>
          </div>

          <!-- Hint -->
          <div id="hint-box">üí° <span id="hint-text">...</span></div>

          <!-- Action Buttons -->
          <div id="btn-row" style="margin-bottom:8px">
            <button class="btn-small btn-hint" onclick="showHint()" style="flex:1">üí° HINT</button>
            <button class="btn-small btn-undo" onclick="undoLastStation()" style="flex:1" id="btn-undo-act">‚Ü© UNDO</button>
          </div>

          <!-- Build -->
          <div id="build-section" style="display:none">
            <div id="fare-preview">
              <strong>üó∫Ô∏è Route:</strong> <span id="route-display">None</span><br>
              <strong>üí∞ Fare:</strong> <span id="fare-display">¬£0.00</span> &nbsp;
              <strong>‚è± Time:</strong> <span id="time-display">0 min</span> &nbsp;
              <strong>üîÑ Changes:</strong> <span id="changes-display">0</span>
            </div>
            <button class="btn-big btn-travel" id="btn-travel" onclick="startTravel()" disabled>
              üöÇ TRAVEL!
            </button>
          </div>
        </div>

        <!-- CARDS TAB -->
        <div id="tab-content-cards" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:24px;margin-bottom:8px;color:var(--oyster-teal)">üÉè ACTIVE DECK (5 max)</h3>
          <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px">Tap to toggle active (gold=active, apply bonuses)</p>
          <div class="card-grid" id="deck-grid"></div>
          <h3 style="font-family:var(--font-h);font-size:24px;margin:12px 0 8px;color:var(--text-dim)">üóÉÔ∏è COLLECTION</h3>
          <div class="card-grid" id="collection-grid"></div>
        </div>

        <!-- SCORES TAB -->
        <div id="tab-content-scores" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:24px;margin-bottom:10px;color:var(--gold)">üèÜ PERSONAL BESTS</h3>
          <div id="milestones-area"></div>
          <table class="pb-table">
            <thead><tr><th>Route</th><th>Score</th><th>Time</th></tr></thead>
            <tbody id="pb-tbody"></tbody>
          </table>
          <h3 style="font-family:var(--font-h);font-size:22px;margin:14px 0 8px;color:var(--tfl-red)">üíÄ WORST RUNS</h3>
          <table class="pb-table">
            <thead><tr><th>Route</th><th>Score</th><th>Time</th></tr></thead>
            <tbody id="worst-tbody"></tbody>
          </table>
        </div>

        <!-- GALLERY TAB -->
        <div id="tab-content-gallery" style="display:none">
          <h3 style="font-family:var(--font-h);font-size:24px;margin-bottom:6px;color:var(--elizabeth)">üìñ CARD GALLERY</h3>
          <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px">
            <span id="gallery-count">0</span>/60 cards collected
          </p>
          <div class="progress-bar"><div class="progress-fill" id="gallery-progress" style="width:0%"></div></div>
          <div class="gallery-grid" id="gallery-grid" style="margin-top:10px"></div>
          <h3 style="font-family:var(--font-h);font-size:22px;margin:12px 0 8px;color:var(--warn)">üèÖ MILESTONES</h3>
          <div id="milestone-list"></div>
          <h3 style="font-family:var(--font-h);font-size:22px;margin:12px 0 8px;color:var(--gold)">üì§ SHARE</h3>
          <button class="btn-big btn-secondary" onclick="shareChallenge()" style="font-size:18px">
            üì§ SHARE CHALLENGE
          </button>
          <div id="share-code" style="margin-top:8px;display:none"></div>
          <h3 style="font-family:var(--font-h);font-size:22px;margin:12px 0 8px;color:var(--oyster-teal)">üí± CARD MARKET</h3>
          <div id="market-area"></div>
        </div>

        <div class="scroll-fade"></div>
      </div>
    </div>

    <!-- RIGHT PANEL - MAP -->
    <div id="right-panel">
      <div id="map-container">
        <div id="phase-banner">üé∞ SPIN TO START</div>
        <div id="timer-display" style="display:none">‚è± 0:00</div>
        <svg id="tube-map" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg">
          <!-- Map rendered by JS -->
        </svg>
        <div id="train-marker" style="display:none">üöÇ</div>
        <div id="event-popup">
          <h2 id="event-icon">‚ö°</h2>
          <p id="event-msg">Event!</p>
          <button class="btn-small btn-secondary" onclick="dismissEvent()">OK</button>
        </div>
        <div id="game-overlay">
          <div id="build-section-map" style="display:none">
            <p style="font-size:13px;color:var(--text-dim);margin-bottom:6px">
              üëÜ Tap stations on the map to build your route
            </p>
            <div id="path-display" style="display:flex;flex-wrap:wrap;gap:4px;min-height:28px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL MODAL -->
<div id="modal-overlay" class="hidden">
  <div id="modal-box">
    <h2>üöá WELCOME TO<br>TUBE QUEST!</h2>
    <p>Collect cards, beat missions, and become the ultimate London Underground champion!</p>
    <div class="modal-step"><em>1. SPIN</em> ‚Äî Bet ¬£20 on the slot machine to get a random mission. Match lines for bonuses!</div>
    <div class="modal-step"><em>2. BUILD</em> ‚Äî Tap stations on the map to plan your route. Fare and time shown live.</div>
    <div class="modal-step"><em>3. TRAVEL</em> ‚Äî Watch your train race the AI. Random events spice things up!</div>
    <div class="modal-step"><em>4. WIN CARDS</em> ‚Äî Beat the goal ‚Üí earn Pok√©mon-style Tube Cards with special powers.</div>
    <div class="modal-step"><em>üí° HINT</em> button shows the optimal route &nbsp; | &nbsp; <em>‚Ü© UNDO</em> removes last station</div>
    <div class="modal-step"><em>üê¢ Slow Mode</em> doubles all timers &nbsp; | &nbsp; <em>üîä Mute</em> silences sounds</div>
    <p style="color:var(--gold);font-weight:900;font-size:16px">Start with ¬£20 Oyster. Lower score = better!</p>
    <button class="btn-big btn-spin" onclick="closeTutorial()" style="margin-top:12px">
      üöá LET'S GO!
    </button>
  </div>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="hidden">
  <div id="result-box">
    <h2 id="result-title">üèÜ MISSION COMPLETE!</h2>
    <div class="result-score" id="result-score">0</div>
    <p style="font-size:14px;color:var(--text-dim)">SCORE (lower = better)</p>
    <div class="result-stat" id="result-time">‚è± Time: 0:00</div>
    <div class="result-stat" id="result-changes">üîÑ Changes: 0</div>
    <div class="result-stat" id="result-fare">üí∞ Fare: ¬£0.00</div>
    <div class="result-stat" id="result-oyster">üÉè Oyster: ¬£0.00</div>
    <div class="result-stat" id="result-pb">üèÖ </div>
    <h3 style="font-family:var(--font-h);font-size:22px;color:var(--gold);margin:10px 0 6px">CARDS WON:</h3>
    <div class="result-cards" id="result-cards"></div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn-big btn-spin" onclick="closeResult()" style="flex:1;font-size:20px">üé∞ AGAIN!</button>
      <button class="btn-big btn-secondary" onclick="shareResult()" style="flex:1;font-size:20px">üì§ SHARE</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const lineColors = {
  B:'#B36305', C:'#FF9900', Ci:'#FFCD00', D:'#00782A', H:'#F25022',
  J:'#968B9C', M:'#9B3777', N:'#000000', P:'#0019A8', V:'#FF0000',
  W:'#00A3E0', E:'#603A9E'
};
const lineNames = {
  B:'Bakerloo',C:'Central',Ci:'Circle',D:'District',H:'Hammersmith & City',
  J:'Jubilee',M:'Metropolitan',N:'Northern',P:'Piccadilly',V:'Victoria',
  W:'Waterloo & City',E:'Elizabeth'
};

const stations = {
  "OXC":"Oxford Circus","PIC":"Piccadilly Circus","CHX":"Charing Cross",
  "EMB":"Embankment","WLO":"Waterloo","BST":"Baker Street","PAD":"Paddington",
  "TCR":"Tottenham Court Road","FAR":"Farringdon","LST":"Liverpool Street",
  "BNK":"Bank","MON":"Monument","MOG":"Moorgate","ALD":"Aldgate",
  "TOW":"Tower Hill","WMS":"Westminster","VIC":"Victoria","GPK":"Green Park",
  "HYC":"Hyde Park Corner","KNT":"Knightsbridge","SKN":"South Kensington",
  "GRD":"Gloucester Road","BCT":"Barons Court","HMD":"Hammersmith",
  "TGR":"Turnham Green","KEW":"Kew Gardens","RIC":"Richmond",
  "OST":"Osterley","HNC":"Hounslow Central",
  "EUS":"Euston","KXX":"Kings Cross St. Pancras","ANG":"Angel",
  "OLD":"Old Street","CAN":"Cannon Street","BLA":"Blackfriars",
  "TMP":"Temple","CXR":"Chancery Lane","HOL":"Holborn",
  "GRR":"Great Portland Street","WAR":"Warren Street",
  "GOO":"Goodge Street","RGS":"Regent's Park","MAR":"Marble Arch",
  "BON":"Bond Street","SHB":"Shepherd's Bush","WHC":"White City",
  "EAL":"Ealing Broadway","ACT":"Acton Town","SGT":"South Ealing",
  "STN":"Stratford","WCH":"Whitechapel","STH":"Stepney Green",
  "MIL":"Mile End","BOW":"Bow Road","BMP":"Bromley-by-Bow",
  "WAN":"Wapping","BER":"Bermondsey","LBR":"London Bridge",
  "SWK":"Southwark","ETH":"Elephant & Castle","OVL":"Oval",
  "STK":"Stockwell","CLH":"Clapham High Street","CLN":"Clapham North",
  "CLS":"Clapham South","BAL":"Balham","TBW":"Tooting Broadway",
  "COL":"Colliers Wood","WIM":"Wimbledon","EDG":"Edgware Road",
  "PDD":"Paddington (D)","CAH":"Cannon Street H","MON2":"Monument M",
  "CNH":"Canary Wharf","CUS":"Custom House","WOO":"Woolwich",
  "ABB":"Abbey Wood","HT5":"Heathrow T5","HT4":"Heathrow T4",
  "HT2":"Heathrow T2&3","HAY":"Hayes & Harlington","STB":"Southall",
  "AML":"Acton Main Line","ILL":"Ilford","CHI":"Chigwell",
  "SHF":"Shenfield","GAD":"Gidea Park","ROM":"Romford",
  "GPW":"Goodmayes","CWH":"Canary Wharf E",
  "SSQ":"Sloane Square","HIG":"Highbury & Islington",
  "FIN":"Finsbury Park","ARS":"Arsenal","HBY":"Holloway Road",
  "CAL":"Caledonian Road","TFP":"Tufnell Park","ARC":"Archway",
  "HGT":"Highgate","EAF":"East Finchley","CHE":"Cheshunt",
  "BRI":"Brixton","STO":"Stockwell N","LPL":"Pimlico",
  "BGR":"Barbican","ALD2":"Aldgate East","SDM":"St. James's Park",
  "FLP":"Fulham Broadway","PKR":"Parsons Green","PTN":"Putney Bridge",
  "ERP":"East Putney","SDN":"Southfields","WAI":"Wimbledon Park",
  "NHP":"North Harrow","HRW":"Harrow-on-the-Hill","CRK":"Chorleywood",
  "AMS":"Amersham"
};

const stationsOnLine = {
  B:["HRW","KNT","BKS","HRN","ELT","STM","KLB","QWN","KIL","WDB","NB","HRH","ELM","MIC","PAD","WLO","ELE","LBR","ELE2","NHP2","OXC","PIC","EMB","CHX"],
  C:["EAL","ACT2","SHB","WHL","HGH","STB2","QLS","CHL","HLN","SFD","MBR","BTH","HOL","TCR","OXC","BNK","LVS","STP","HFD","LTH","LAT","LYT","EPS","CHI2"],
  Ci:["HAM","GOL","RAV","STB3","TGR3","ACT","OLK","SHN","EAL2","WHL2","BCT2","ERP2","SDL","FUL","PKR2","PUT","WHF","BCT","GRD","SKN","GLR","SLQ","VIC","SDM","WMS","EMB","BLA","TMP","CAN","MON","BNK","ALG","ALB","LPT","ALH","FSB","MOG","KXX","YRK","GTS","FAR","BGR","ALG2","BRK","BLP"],
  D:["RMD","KWD","RCH","GTY","STB","TGR","ACT","ALN","ERL","HMD","PRS","FUL","PKR","PTN","ERP","SDN","WAI","WIM","SLQ","GLR","SKN","ECR","HYC","BMP3","SDM","WMS","BLA","TMP","CHN","MON","BNK","THL","ALG","TBR","STH","MIL","BOW","BMP","BRB","WHL","STR","UPN"],
  H:["WHL3","PHT","HOG","STB4","TGR4","ACT2","OLD4","GFL","EUS2","KXX2","FAR2","BGR2","ALG3","ALB2","WCH2","STP2","LVT","UCH"],
  J:["SBY","FIN3","WPN","GLN","NCT","WHR","BKR","BST","BND","BGS","ZSQ","WHN","HBR","WLO","BRM","LBR","CNH","CPK","NFY","NWC","CFE"],
  M:["AMS","CST","ALB","CHN2","DKN","WRB","HRW","NHP","NWK","GBY","RSL","KNH","WMB","BAK","GRS","EUS3","KXX3","ALD4","FAR3","BGR3","ALG4","ALB3","MON3"],
  N:["CHE","ENT","HGH2","ARC","HGT","EFN","FRP","TFP","CLD","ANG","OLK","BNK","LBR","MGB","STO","CLN","CLH","CLS","BAL","TBW","CLW","MOD","NTP"],
  P:["HT5","HT4","HT2","HAY","STB5","OST","HNC","IFD","BOS","GRN","CHW","ACT3","HMD2","BCT","GRD","SKN","KNT","HYC","GPK","GRN","PIC","COV","LES","HLD","ARS","FIN2","SBY2","OAK","COC"],
  V:["BRI","STK","LPL","VIC","GPK","OXC","WAR","EUS","HIG2"],
  E:["ABB","WOO","CUS","CWH","CRW","WCH","STP3","FSB","FAR","TCR","BND","PAD","AML","EAL","STR","ROF","ILL","GAD","SHF","HAY","STB6","HT2","HT4","HT5"]
};

// Station positions on 900x600 SVG
const stationPos = {
  "OXC":[380,200],"PIC":[350,230],"CHX":[340,270],"EMB":[360,280],
  "WLO":[370,295],"BST":[310,175],"PAD":[280,200],"TCR":[390,210],
  "FAR":[430,200],"LST":[480,200],"BNK":[470,230],"MON":[475,235],
  "MOG":[465,200],"ALD":[490,220],"TOW":[510,240],"WMS":[330,280],
  "VIC":[310,290],"GPK":[310,240],"HYC":[285,255],"KNT":[265,255],
  "SKN":[245,265],"GRD":[235,270],"BCT":[170,290],"HMD":[155,280],
  "TGR":[130,280],"KEW":[110,295],"RIC":[90,310],"OST":[100,270],
  "HNC":[80,270],"EUS":[400,170],"KXX":[415,165],"ANG":[460,165],
  "OLD":[475,180],"CAN":[475,245],"BLA":[430,265],"TMP":[405,270],
  "CXR":[405,215],"HOL":[415,215],"GRR":[340,170],"WAR":[350,190],
  "GOO":[365,200],"RGS":[340,185],"MAR":[295,240],"BON":[295,235],
  "SHB":[200,230],"WHC":[210,225],"EAL":[80,240],"ACT":[145,260],
  "STN":[570,200],"WCH":[530,215],"STH":[530,225],"MIL":[540,225],
  "BOW":[555,215],"BMP":[565,220],"WAN":[510,255],"BER":[500,265],
  "LBR":[490,265],"SWK":[475,275],"ETH":[450,295],"OVL":[415,310],
  "STK":[410,315],"CLH":[400,330],"CLN":[400,325],"CLS":[395,340],
  "BAL":[385,355],"TBW":[375,370],"COL":[360,385],"WIM":[330,395],
  "EDG":[260,200],"CNH":[580,255],"CUS":[595,255],"WOO":[620,270],
  "ABB":[640,275],"HT5":[30,250],"HT4":[40,260],"HT2":[55,250],
  "HAY":[65,240],"STB":[110,240],"AML":[155,245],"ILL":[610,200],
  "SHF":[690,190],"GAD":[650,195],"ROM":[665,200],
  "CWH":[575,255],"HIG":[480,165],"FIN":[450,150],"ARS":[455,155],
  "HBY":[460,160],"CAL":[420,155],"TFP":[425,150],"ARC":[440,145],
  "HGT":[445,140],"EAF":[450,135],"BRI":[415,325],"LPL":[320,300],
  "BGR":[455,205],"ALD2":[490,215],"SDM":[325,275],"FLP":[200,280],
  "PKR":[215,285],"PTN":[220,295],"ERP":[225,305],"SDN":[250,305],
  "WAI":[275,315],"HRW":[200,140],"AMS":[60,120],"NHP":[210,150],
  "SSL":[295,280],"FIN2":[448,152]
};

const zones = {
  "OXC":1,"PIC":1,"CHX":1,"EMB":1,"WLO":1,"BST":1,"PAD":1,"TCR":1,
  "FAR":1,"LST":1,"BNK":1,"MON":1,"MOG":1,"ALD":1,"TOW":1,"WMS":1,
  "VIC":1,"GPK":1,"HYC":1,"KNT":1,"SKN":1,"GRD":1,"BCT":2,"HMD":2,
  "TGR":2,"KEW":3,"RIC":4,"OST":4,"HNC":4,"EUS":1,"KXX":1,"ANG":1,
  "OLD":1,"CAN":1,"BLA":1,"TMP":1,"CXR":1,"HOL":1,"GRR":1,"WAR":1,
  "GOO":1,"RGS":1,"MAR":1,"BON":1,"SHB":2,"WHC":2,"EAL":3,"ACT":3,
  "STN":2,"WCH":2,"STH":2,"MIL":2,"BOW":2,"BMP":3,"LBR":1,"SWK":1,
  "ETH":1,"OVL":2,"STK":2,"CLH":2,"CLN":2,"CLS":2,"BAL":3,"TBW":3,
  "COL":3,"WIM":3,"CNH":2,"CUS":3,"WOO":4,"ABB":4,
  "HT5":6,"HT4":6,"HT2":6,"HAY":5,"STB":4,"AML":3,"ILL":4,"SHF":7,
  "GAD":5,"ROM":5,"CWH":2,"HIG":2,"FIN":2,"ARS":2,"BRI":2,"LPL":1,
  "BGR":1,"HRW":5,"AMS":9,"NHP":5
};

// ============================================================
// CARD DEFINITIONS
// ============================================================
const cardDefs = [
  {id:"E01",name:"Elizabeth Express",line:"E",color:"#603A9E",stats:{speed:9,crowd:3},ability:"-2min on E-line"},
  {id:"E02",name:"Crossrail Commuter",line:"E",color:"#7B4FB5",stats:{speed:8,crowd:4},ability:"Free Z1‚ÜíZ2 transfer"},
  {id:"E03",name:"Heathrow Hopper",line:"E",color:"#5A2E8A",stats:{speed:7,crowd:5},ability:"Airport bonus x1.5"},
  {id:"E04",name:"Paddington Bear",line:"E",color:"#8B5FB8",stats:{speed:6,crowd:6},ability:"PAD interchange free"},
  {id:"V01",name:"Victoria Viper",line:"V",color:"#FF0000",stats:{speed:9,crowd:5},ability:"Rush skip 1 event"},
  {id:"V02",name:"Brixton Beat",line:"V",color:"#CC0000",stats:{speed:7,crowd:7},ability:"+¬£1 on V wins"},
  {id:"V03",name:"Victoria Veteran",line:"V",color:"#FF3333",stats:{speed:6,crowd:6},ability:"Rare: +10 score"},
  {id:"J01",name:"Jubilee Jet",line:"J",color:"#A0998A",stats:{speed:8,crowd:4},ability:"CNH docks fast -1min"},
  {id:"J02",name:"Jubilee Ninja",line:"J",color:"#968B9C",stats:{speed:7,crowd:5},ability:"Dodge 1 Mug event"},
  {id:"J03",name:"Silver Streaker",line:"J",color:"#7A7080",stats:{speed:8,crowd:3},ability:"No delays on J"},
  {id:"N01",name:"Northern Nightmare",line:"N",color:"#222222",stats:{speed:5,crowd:9},ability:"Night bonus double ¬£"},
  {id:"N02",name:"Morden Maverick",line:"N",color:"#333333",stats:{speed:6,crowd:8},ability:"South loop shortcut"},
  {id:"N03",name:"Bank Bandit",line:"N",color:"#111111",stats:{speed:7,crowd:6},ability:"BNK transfer free"},
  {id:"C01",name:"Central Champ",line:"C",color:"#FF0000",stats:{speed:8,crowd:7},ability:"EAL fast express"},
  {id:"C02",name:"Red Racer",line:"C",color:"#CC0000",stats:{speed:9,crowd:6},ability:"-1min per C station"},
  {id:"P01",name:"Piccadilly Pioneer",line:"P",color:"#0019A8",stats:{speed:7,crowd:6},ability:"HT fast +¬£2 bonus"},
  {id:"P02",name:"Airport Ace",line:"P",color:"#0033CC",stats:{speed:8,crowd:5},ability:"Heathrow missions +20"},
  {id:"B01",name:"Bakerloo Baker",line:"B",color:"#B36305",stats:{speed:5,crowd:7},ability:"OXC free change"},
  {id:"D01",name:"District Dasher",line:"D",color:"#00782A",stats:{speed:6,crowd:6},ability:"WIM express ‚àí2min"},
  {id:"D02",name:"District Dragon",line:"D",color:"#005A20",stats:{speed:7,crowd:5},ability:"Rare find +¬£3"},
  {id:"Ci01",name:"Circle Spinner",line:"Ci",color:"#FFCD00",stats:{speed:5,crowd:5},ability:"Loop bonus free ¬£"},
  {id:"M01",name:"Metro Master",line:"M",color:"#9B3777",stats:{speed:6,crowd:4},ability:"AMS rare +card"},
  {id:"W01",name:"Waterloo Wave",line:"W",color:"#00A3E0",stats:{speed:9,crowd:3},ability:"2-stop blitz ‚àí3min"},
  {id:"SPEC1",name:"‚≠ê Rush Hour Hero",line:"E",color:"#FFD700",stats:{speed:10,crowd:2},ability:"Legendary: all ‚àí3min"},
  {id:"SPEC2",name:"üëë Oyster King",line:"J",color:"#FF8C00",stats:{speed:8,crowd:2},ability:"All fares ‚àí20%"},
  {id:"SPEC3",name:"üåô Night Tube Legend",line:"N",color:"#1A1A2E",stats:{speed:7,crowd:1},ability:"Events +¬£ instead"},
  {id:"SPEC4",name:"üöÑ Elizabeth MVP",line:"E",color:"#7B2D8B",stats:{speed:10,crowd:1},ability:"All E missions auto-win"},
];

// ============================================================
// GRAPH BUILDING
// ============================================================
const graph = {}; // adjacency: {station: [{station, time, line, isChange}]}

function buildGraph() {
  for (const s in stations) graph[s] = [];
  
  for (const [lineCode, lineStops] of Object.entries(stationsOnLine)) {
    const validStops = lineStops.filter(s => stations[s]);
    for (let i=0; i<validStops.length-1; i++) {
      const a = validStops[i], b = validStops[i+1];
      if (!graph[a]) graph[a] = [];
      if (!graph[b]) graph[b] = [];
      const t = lineCode === 'E' ? 2 : 2;
      graph[a].push({to:b, time:t, line:lineCode});
      graph[b].push({to:a, time:t, line:lineCode});
    }
  }
}

function bfs(start, end) {
  if (start === end) return {path:[start], time:0, changes:0, lines:[]};
  const queue = [{node:start, path:[start], time:0, changes:0, lastLine:null, lines:[]}];
  const visited = new Map();
  
  while (queue.length) {
    queue.sort((a,b)=>a.time-b.time);
    const {node, path, time, changes, lastLine, lines} = queue.shift();
    const key = `${node}:${lastLine}`;
    if (visited.has(key)) continue;
    visited.set(key, true);
    
    for (const edge of (graph[node]||[])) {
      if (path.includes(edge.to)) continue;
      const isChange = lastLine && lastLine !== edge.line;
      const addTime = edge.time + (isChange ? 4 : 0);
      const newPath = [...path, edge.to];
      if (edge.to === end) {
        return {path:newPath, time:time+addTime, changes:changes+(isChange?1:0), lines:[...lines, edge.line]};
      }
      queue.push({node:edge.to, path:newPath, time:time+addTime, 
        changes:changes+(isChange?1:0), lastLine:edge.line, lines:[...lines,edge.line]});
    }
  }
  return null;
}

function getLineForEdge(a, b) {
  if (!graph[a]) return null;
  const e = graph[a].find(x=>x.to===b);
  return e ? e.line : null;
}

// ============================================================
// GAME STATE
// ============================================================
let gameState = {
  oyster: 20.00,
  deck: [],
  collection: [],
  pbs: [],
  worsts: [],
  streak: 0,
  lastDay: null,
  tutorialSeen: false,
  milestones: {},
  galleryAll: [],
  muted: false,
  slowMode: false
};

let missionState = {
  active: false,
  start: null,
  end: null,
  goal: null,
  playerPath: [],
  confirmed: false,
  travelling: false,
  startTime: null,
  elapsed: 0,
  timerInterval: null,
  playerResult: null,
  aiResult: null
};

// ============================================================
// SAVE / LOAD
// ============================================================
function saveState() {
  try { localStorage.setItem('tubequest_v2', JSON.stringify(gameState)); } catch(e){}
}
function loadState() {
  try {
    const d = localStorage.getItem('tubequest_v2');
    if (d) {
      const saved = JSON.parse(d);
      Object.assign(gameState, saved);
    }
  } catch(e){}
  checkDailyReset();
}
function checkDailyReset() {
  const today = new Date().toDateString();
  if (gameState.lastDay && gameState.lastDay !== today) {
    if (!gameState.wonToday) gameState.streak = 0;
    gameState.wonToday = false;
  }
  gameState.lastDay = today;
}

// ============================================================
// AUDIO (base64-free, WebAudio synth)
// ============================================================
let audioCtx = null;
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playSound(type) {
  if (gameState.muted) return;
  try {
    const ctx = getAudio();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    const t = ctx.currentTime;
    if (type==='spin') {
      osc.type='square'; osc.frequency.setValueAtTime(200,t);
      osc.frequency.exponentialRampToValueAtTime(800,t+0.3);
      gain.gain.setValueAtTime(0.2,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.4);
      osc.start(t); osc.stop(t+0.4);
    } else if (type==='ding') {
      osc.type='sine'; osc.frequency.setValueAtTime(880,t);
      osc.frequency.exponentialRampToValueAtTime(1760,t+0.15);
      gain.gain.setValueAtTime(0.3,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.5);
      osc.start(t); osc.stop(t+0.5);
    } else if (type==='cha') {
      osc.type='triangle'; osc.frequency.setValueAtTime(660,t);
      osc.frequency.exponentialRampToValueAtTime(1320,t+0.1);
      gain.gain.setValueAtTime(0.25,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      osc.start(t); osc.stop(t+0.3);
    } else if (type==='buzz') {
      osc.type='sawtooth'; osc.frequency.setValueAtTime(150,t);
      gain.gain.setValueAtTime(0.3,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.6);
      osc.start(t); osc.stop(t+0.6);
    } else if (type==='chug') {
      osc.type='square'; osc.frequency.setValueAtTime(80,t);
      osc.frequency.setValueAtTime(100,t+0.1); osc.frequency.setValueAtTime(80,t+0.2);
      gain.gain.setValueAtTime(0.15,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.5);
      osc.start(t); osc.stop(t+0.5);
    }
  } catch(e){}
}

// ============================================================
// MISSIONS
// ============================================================
const missionGoals = [
  {text:"Under 20 min", type:"time", value:20},
  {text:"Max 2 changes", type:"changes", value:2},
  {text:"Under ¬£5 fare", type:"fare", value:5},
  {text:"Under 30 min", type:"time", value:30},
  {text:"Max 1 change", type:"changes", value:1},
  {text:"Rush hour: any route!", type:"any", value:null},
  {text:"Beat the AI!", type:"ai", value:null},
  {text:"Under ¬£4 fare", type:"fare", value:4},
  {text:"Under 15 min", type:"time", value:15},
  {text:"Cheapest route", type:"fare", value:3},
];

const stationKeys = Object.keys(stations).filter(s => stationPos[s]);

function getRandomStation(exclude=[]) {
  let tries = 0;
  while(tries++ < 100) {
    const s = stationKeys[Math.floor(Math.random()*stationKeys.length)];
    if (!exclude.includes(s)) return s;
  }
  return stationKeys[0];
}

function spinMission() {
  if (missionState.travelling) return;
  if (gameState.oyster < 20) {
    showEvent("üí∏","Not enough Oyster! Need ¬£20 to spin.",[]);
    return;
  }
  
  playSound('spin');
  gameState.oyster -= 20;
  updateOysterDisplay();
  
  // Reset mission
  missionState = {
    active: false, start: null, end: null, goal: null,
    playerPath: [], confirmed: false, travelling: false,
    startTime: null, elapsed: 0, timerInterval: null,
    playerResult: null, aiResult: null
  };
  
  // Spin reels
  const reels = ['reel-start','reel-end','reel-goal'];
  reels.forEach(r => {
    const el = document.getElementById(r);
    el.classList.add('spinning');
    el.classList.remove('landed');
  });
  
  let spinCount = 0;
  const spinInterval = setInterval(() => {
    const tmpStart = getRandomStation();
    const tmpEnd = getRandomStation([tmpStart]);
    const tmpGoal = missionGoals[Math.floor(Math.random()*missionGoals.length)];
    document.getElementById('reel-start').innerHTML = `üöá<br><span style="font-size:9px">${stations[tmpStart]?.substring(0,10)||'?'}</span>`;
    document.getElementById('reel-end').innerHTML = `üèÅ<br><span style="font-size:9px">${stations[tmpEnd]?.substring(0,10)||'?'}</span>`;
    document.getElementById('reel-goal').innerHTML = `üéØ<br><span style="font-size:9px">${tmpGoal.text.substring(0,12)}</span>`;
    spinCount++;
  }, 80);
  
  setTimeout(() => {
    clearInterval(spinInterval);
    
    let start = getRandomStation();
    let end = getRandomStation([start]);
    // Ensure route exists
    let route = bfs(start,end);
    let attempts = 0;
    while ((!route || route.path.length < 3) && attempts++ < 20) {
      start = getRandomStation();
      end = getRandomStation([start]);
      route = bfs(start,end);
    }
    const goal = missionGoals[Math.floor(Math.random()*missionGoals.length)];
    
    missionState.start = start;
    missionState.end = end;
    missionState.goal = goal;
    missionState.active = true;
    missionState.playerPath = [start];
    
    reels.forEach(r => {
      document.getElementById(r).classList.remove('spinning');
      document.getElementById(r).classList.add('landed');
    });
    
    document.getElementById('reel-start').innerHTML = 
      `üöá<br><span style="font-size:9px">${stations[start].substring(0,12)}</span>`;
    document.getElementById('reel-end').innerHTML = 
      `üèÅ<br><span style="font-size:9px">${stations[end].substring(0,12)}</span>`;
    document.getElementById('reel-goal').innerHTML = 
      `üéØ<br><span style="font-size:9px">${goal.text}</span>`;
    
    playSound('ding');
    updateMissionCard();
    updateMap();
    updateBuildSection();
    document.getElementById('phase-banner').textContent = 'üó∫Ô∏è BUILD YOUR ROUTE';
    document.getElementById('build-section-map').style.display = 'block';
    
    saveState();
  }, 1800);
}

function updateMissionCard() {
  if (!missionState.start) return;
  const mc = document.getElementById('mission-card');
  mc.innerHTML = `
    <h3>üéØ ACTIVE MISSION</h3>
    <div class="mission-route">${stations[missionState.start]} ‚Üí ${stations[missionState.end]}</div>
    <div class="mission-detail">
      <span class="mission-badge">üéØ ${missionState.goal.text}</span>
      <span class="mission-badge">üí∞ Oyster: ¬£${gameState.oyster.toFixed(2)}</span>
    </div>
  `;
}

// ============================================================
// MAP SVG
// ============================================================
function buildMap() {
  const svg = document.getElementById('tube-map');
  const W=900, H=600;
  
  // Background
  svg.innerHTML = `<rect width="${W}" height="${H}" fill="#0A0E1A"/>
    <text x="${W/2}" y="${H/2}" text-anchor="middle" dominant-baseline="middle" 
      font-size="200" fill="rgba(255,255,255,0.02)" font-family="'Bebas Neue',sans-serif" font-weight="bold">
      TfL
    </text>`;
  
  // Draw lines
  for (const [lineCode, stops] of Object.entries(stationsOnLine)) {
    const col = lineColors[lineCode] || '#888';
    const validStops = stops.filter(s => stationPos[s]);
    for (let i=0; i<validStops.length-1; i++) {
      const a = stationPos[validStops[i]];
      const b = stationPos[validStops[i+1]];
      if (!a||!b) continue;
      const el = document.createElementNS('http://www.w3.org/2000/svg','line');
      el.setAttribute('x1',a[0]); el.setAttribute('y1',a[1]);
      el.setAttribute('x2',b[0]); el.setAttribute('y2',b[1]);
      el.setAttribute('stroke',col); el.setAttribute('stroke-width','3');
      el.setAttribute('stroke-linecap','round'); el.setAttribute('opacity','0.7');
      svg.appendChild(el);
    }
  }
  
  // Station dots
  const drawnStations = new Set();
  for (const [code, pos] of Object.entries(stationPos)) {
    if (!stations[code] || drawnStations.has(code)) continue;
    drawnStations.add(code);
    
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('class','station-dot');
    g.setAttribute('id','dot-'+code);
    g.setAttribute('transform',`translate(${pos[0]},${pos[1]})`);
    g.addEventListener('click', ()=>tapStation(code));
    
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('r','5'); circle.setAttribute('fill','#fff');
    circle.setAttribute('stroke','#333'); circle.setAttribute('stroke-width','1.5');
    
    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
    text.setAttribute('y','16'); text.setAttribute('text-anchor','middle');
    text.setAttribute('font-size','7'); text.setAttribute('fill','rgba(255,255,255,0.6)');
    text.setAttribute('font-family','Nunito,sans-serif'); text.setAttribute('font-weight','bold');
    text.textContent = stations[code]?.length > 12 ? stations[code].substring(0,10)+'‚Ä¶' : (stations[code]||code);
    
    g.appendChild(circle);
    g.appendChild(text);
    svg.appendChild(g);
  }
}

function updateMap() {
  // Reset all dots
  document.querySelectorAll('.station-dot').forEach(d => {
    d.classList.remove('selected','on-path','start-station','end-station');
    const c = d.querySelector('circle');
    if (c) { c.setAttribute('fill','#fff'); c.setAttribute('r','5'); }
  });
  
  if (!missionState.start) return;
  
  // Mark start/end
  const startDot = document.getElementById('dot-'+missionState.start);
  const endDot = document.getElementById('dot-'+missionState.end);
  if (startDot) {
    startDot.classList.add('start-station');
    const c = startDot.querySelector('circle');
    if (c) { c.setAttribute('fill','#E11B22'); c.setAttribute('r','9'); }
  }
  if (endDot) {
    endDot.classList.add('end-station');
    const c = endDot.querySelector('circle');
    if (c) { c.setAttribute('fill','#FF6B35'); c.setAttribute('r','9'); }
  }
  
  // Mark path
  missionState.playerPath.forEach(s => {
    const dot = document.getElementById('dot-'+s);
    if (dot && s !== missionState.start && s !== missionState.end) {
      dot.classList.add('on-path');
      const c = dot.querySelector('circle');
      if (c) { c.setAttribute('fill','#00C851'); c.setAttribute('r','7'); }
    }
  });
  
  // Update path display
  updatePathDisplay();
  updateFarePreview();
}

function tapStation(code) {
  if (!missionState.active || missionState.travelling) return;
  
  // Can't retap start
  if (code === missionState.start && missionState.playerPath.length === 1) return;
  
  // Check if already in path (except start)
  if (missionState.playerPath.includes(code) && code !== missionState.start) {
    // Trim path to this point
    const idx = missionState.playerPath.indexOf(code);
    missionState.playerPath = missionState.playerPath.slice(0, idx+1);
  } else {
    // Add to path
    missionState.playerPath.push(code);
  }
  
  playSound('chug');
  updateMap();
  
  // Show build section
  document.getElementById('build-section').style.display = 'block';
  
  // Enable travel if end station reached
  const travelBtn = document.getElementById('btn-travel');
  if (missionState.playerPath[missionState.playerPath.length-1] === missionState.end && missionState.playerPath.length >= 2) {
    travelBtn.disabled = false;
  } else {
    travelBtn.disabled = true;
  }
}

function updatePathDisplay() {
  const pd = document.getElementById('path-display');
  if (!pd) return;
  pd.innerHTML = missionState.playerPath.map((s,i) => {
    const line = i>0 ? getLineForEdge(missionState.playerPath[i-1], s) : null;
    const col = line ? lineColors[line] : '#888';
    return `<span class="path-node" style="border-left:3px solid ${col}">
      ${i===0?'üöá':i===missionState.playerPath.length-1&&s===missionState.end?'üèÅ':'‚óè'} 
      ${stations[s]?.substring(0,8)||s}
    </span>`;
  }).join('');
}

function updateFarePreview() {
  const path = missionState.playerPath;
  if (path.length < 2) {
    document.getElementById('route-display').textContent = 'Tap stations to build route';
    document.getElementById('fare-display').textContent = '¬£0.00';
    document.getElementById('time-display').textContent = '0 min';
    document.getElementById('changes-display').textContent = '0';
    return;
  }
  const result = calculateRoute(path);
  document.getElementById('route-display').textContent = `${path.length} stations`;
  document.getElementById('fare-display').textContent = `¬£${result.fare.toFixed(2)}`;
  document.getElementById('time-display').textContent = `${result.time} min`;
  document.getElementById('changes-display').textContent = result.changes;
}

function calculateRoute(path) {
  let time = 0, changes = 0, lastLine = null;
  const startZone = zones[path[0]] || 1;
  const endZone = zones[path[path.length-1]] || 1;
  const maxZone = Math.max(startZone, endZone);
  
  for (let i=0; i<path.length-1; i++) {
    const edge = (graph[path[i]]||[]).find(e=>e.to===path[i+1]);
    const t = edge ? edge.time : 3;
    const line = edge ? edge.line : null;
    if (lastLine && line && lastLine !== line) {
      changes++;
      time += 4;
    }
    time += t;
    lastLine = line || lastLine;
  }
  
  // Apply card bonuses
  const activeCards = gameState.deck.filter(c=>c.active);
  let timeMod = 0;
  activeCards.forEach(c => {
    const def = cardDefs.find(d=>d.id===c.id);
    if (!def) return;
    if (def.ability.includes('-2min')) timeMod -= 2;
    if (def.ability.includes('-3min')) timeMod -= 3;
    if (def.ability.includes('-1min')) timeMod -= 1;
  });
  time = Math.max(1, time + timeMod);
  
  // Fare: Z1=¬£2.50, +¬£1.50/change, +¬£0.50/extra zone, Elizabeth cheap
  let fare = 2.50;
  if (maxZone > 1) fare += (maxZone-1)*0.50;
  fare += changes * 1.50;
  
  // Oyster cap
  const hasOysterKing = activeCards.some(c=>c.id==='SPEC2');
  if (hasOysterKing) fare *= 0.8;
  fare = Math.min(fare, 15);
  fare = Math.max(fare, 1.50);
  
  if (gameState.slowMode) time *= 2;
  
  return {time, changes, fare: parseFloat(fare.toFixed(2))};
}

function updateBuildSection() {
  document.getElementById('build-section').style.display = missionState.active ? 'block' : 'none';
  document.getElementById('btn-travel').disabled = true;
  updateFarePreview();
}

// ============================================================
// UNDO / HINT
// ============================================================
function undoLastStation() {
  if (missionState.playerPath.length > 1) {
    missionState.playerPath.pop();
    updateMap();
    const travelBtn = document.getElementById('btn-travel');
    travelBtn.disabled = true;
  }
}

function showHint() {
  if (!missionState.start || !missionState.end) return;
  const opt = bfs(missionState.start, missionState.end);
  const hb = document.getElementById('hint-box');
  const ht = document.getElementById('hint-text');
  if (opt) {
    const next = opt.path[1];
    ht.textContent = `Optimal: ${opt.path.length} stops, ${opt.time}min, ${opt.changes} changes. Next: ${stations[next]||next}`;
  } else {
    ht.textContent = 'No direct route found ‚Äî try a different path!';
  }
  hb.classList.add('show');
  hb.style.display = 'block';
  setTimeout(()=>{ hb.classList.remove('show'); hb.style.display='none'; }, 5000);
}

// ============================================================
// TRAVEL
// ============================================================
function startTravel() {
  if (!missionState.active || missionState.travelling) return;
  if (missionState.playerPath[missionState.playerPath.length-1] !== missionState.end) return;
  
  const routeResult = calculateRoute(missionState.playerPath);
  const fare = routeResult.fare;
  
  if (gameState.oyster < fare) {
    showEvent("üí∏",`Not enough Oyster! Need ¬£${fare.toFixed(2)}`,[]);
    return;
  }
  
  gameState.oyster -= fare;
  updateOysterDisplay();
  
  missionState.travelling = true;
  missionState.startTime = Date.now();
  missionState.playerResult = routeResult;
  
  // AI BFS
  const aiRoute = bfs(missionState.start, missionState.end);
  missionState.aiResult = aiRoute ? calculateRoute(aiRoute.path) : null;
  
  document.getElementById('phase-banner').textContent = 'üöÇ TRAVELLING...';
  document.getElementById('timer-display').style.display = 'block';
  
  // Start timer
  missionState.timerInterval = setInterval(() => {
    missionState.elapsed = Math.floor((Date.now() - missionState.startTime)/1000);
    const m = Math.floor(missionState.elapsed/60);
    const s = missionState.elapsed%60;
    document.getElementById('timer-display').textContent = `‚è± ${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);
  
  animateTrain();
}

function animateTrain() {
  const path = missionState.playerPath;
  const train = document.getElementById('train-marker');
  train.style.display = 'flex';
  
  let idx = 0;
  const step = () => {
    if (idx >= path.length) {
      // Journey complete
      setTimeout(()=>{
        train.style.display = 'none';
        finishTravel();
      }, 500);
      return;
    }
    
    const pos = stationPos[path[idx]];
    if (pos) {
      const rect = document.getElementById('map-container').getBoundingClientRect();
      const svg = document.getElementById('tube-map');
      const vbW=900, vbH=600;
      const scaleX = rect.width/vbW;
      const scaleY = rect.height/vbH;
      train.style.left = (pos[0]*scaleX - 18) + 'px';
      train.style.top = (pos[1]*scaleY - 10) + 'px';
    }
    
    // Random events
    if (idx > 0 && Math.random() < 0.18) {
      triggerRandomEvent(idx, path.length);
    }
    
    idx++;
    const delay = (gameState.slowMode ? 2400 : 1200) / path.length * 4;
    setTimeout(step, Math.max(600, delay));
  };
  
  step();
}

function triggerRandomEvent(idx, total) {
  const events = [
    {icon:"‚ö†Ô∏è", msg:"Signal failure! +2 min delay", effect:()=>{ missionState.playerResult.time += 2; }},
    {icon:"üòà", msg:"Someone nicked your Oyster card! Lost a card!", effect:()=>{ 
      if (gameState.deck.length > 0) {
        const lost = gameState.deck.splice(Math.floor(Math.random()*gameState.deck.length),1)[0];
        const def = cardDefs.find(d=>d.id===lost.id);
        document.getElementById('event-msg').textContent = `Snatched! Lost "${def?.name||'card'}" üò±`;
      }
    }},
    {icon:"üéÅ", msg:"Bonus card stolen from AI!", effect:()=>{ 
      const rand = cardDefs[Math.floor(Math.random()*cardDefs.length)];
      addCard(rand.id);
      document.getElementById('event-msg').textContent = `Found rare card: ${rand.name}! üéâ`;
    }},
    {icon:"‚ö°", msg:"Express service! -1 min", effect:()=>{ missionState.playerResult.time = Math.max(1,missionState.playerResult.time-1); }},
    {icon:"üêå", msg:"Leaf on the line... +3 min", effect:()=>{ missionState.playerResult.time += 3; }},
  ];
  
  // Check for card immunity
  const hasNinja = gameState.deck.some(c=>c.id==='J02'&&c.active);
  const ev = events[Math.floor(Math.random()*events.length)];
  
  if (ev.icon==='üòà' && hasNinja) {
    showEventBrief("üòé","Jubilee Ninja blocked the mugger!");
    return;
  }
  
  ev.effect();
  showEventBrief(ev.icon, ev.msg);
  playSound('buzz');
}

function showEventBrief(icon, msg) {
  const popup = document.getElementById('event-popup');
  document.getElementById('event-icon').textContent = icon;
  document.getElementById('event-msg').textContent = msg;
  popup.classList.add('show');
  setTimeout(()=>popup.classList.remove('show'), 2500);
}

function showEvent(icon, msg, actions) {
  const popup = document.getElementById('event-popup');
  document.getElementById('event-icon').textContent = icon;
  document.getElementById('event-msg').textContent = msg;
  popup.classList.add('show');
}

function dismissEvent() {
  document.getElementById('event-popup').classList.remove('show');
}

function finishTravel() {
  clearInterval(missionState.timerInterval);
  document.getElementById('timer-display').style.display = 'none';
  
  const result = missionState.playerResult;
  const goal = missionState.goal;
  const aiResult = missionState.aiResult;
  
  // Check goal
  let goalMet = false;
  if (goal.type === 'time') goalMet = result.time <= goal.value;
  else if (goal.type === 'changes') goalMet = result.changes <= goal.value;
  else if (goal.type === 'fare') goalMet = result.fare <= goal.value;
  else if (goal.type === 'any') goalMet = true;
  else if (goal.type === 'ai') goalMet = aiResult ? result.time <= aiResult.time : true;
  
  // Score = time * changes+1 * fare / 100 (lower=better)
  const score = Math.max(1, Math.round((result.time * (result.changes+1) * result.fare) / 10));
  
  // Win cards
  const wonCards = [];
  if (goalMet) {
    const cardPool = cardDefs.filter(c => !gameState.collection.some(gc=>gc.id===c.id));
    if (cardPool.length > 0) {
      const card = cardPool[Math.floor(Math.random()*cardPool.length)];
      wonCards.push(card);
      addCard(card.id);
      playSound('cha');
    }
    // Oyster refund partial
    const bonus = goalMet ? 5 : 2;
    gameState.oyster += bonus;
    updateOysterDisplay();
  } else {
    playSound('buzz');
  }
  
  // PB check
  const routeKey = `${missionState.start}‚Üí${missionState.end}`;
  const existing = gameState.pbs.find(p=>p.route===routeKey);
  let isPB = false;
  if (!existing || score < existing.score) {
    gameState.pbs = gameState.pbs.filter(p=>p.route!==routeKey);
    gameState.pbs.push({route:`${stations[missionState.start]}‚Üí${stations[missionState.end]}`, score, time:result.time});
    gameState.pbs.sort((a,b)=>a.score-b.score);
    if (gameState.pbs.length > 10) gameState.pbs = gameState.pbs.slice(0,10);
    isPB = true;
  }
  
  // Worsts
  gameState.worsts.push({route:`${stations[missionState.start]}‚Üí${stations[missionState.end]}`, score, time:result.time});
  gameState.worsts.sort((a,b)=>b.score-a.score);
  if (gameState.worsts.length>5) gameState.worsts=gameState.worsts.slice(0,5);
  
  // Streak
  if (goalMet) {
    gameState.streak++;
    gameState.wonToday = true;
  }
  
  // Milestone check
  checkMilestones();
  
  saveState();
  showResult(goalMet, score, result, wonCards, isPB);
  
  missionState.active = false;
  missionState.travelling = false;
  document.getElementById('phase-banner').textContent = 'üé∞ SPIN TO START';
  document.getElementById('build-section-map').style.display = 'none';
}

function addCard(id) {
  const def = cardDefs.find(d=>d.id===id);
  if (!def) return;
  // Check for dupe
  if (gameState.collection.some(c=>c.id===id)) {
    gameState.oyster += 2; // dupe ‚Üí ¬£2
    updateOysterDisplay();
    return;
  }
  const card = {id, active: gameState.deck.filter(c=>c.active).length < 5};
  gameState.collection.push(card);
  gameState.deck = [...gameState.collection];
}

// ============================================================
// RESULT SCREEN
// ============================================================
function showResult(won, score, result, wonCards, isPB) {
  const rs = document.getElementById('result-screen');
  rs.classList.remove('hidden');
  
  document.getElementById('result-title').textContent = won ? 'üèÜ MISSION COMPLETE!' : 'üíÄ MISSION FAILED!';
  document.getElementById('result-title').style.color = won ? 'var(--gold)' : 'var(--tfl-red)';
  document.getElementById('result-score').textContent = score;
  document.getElementById('result-time').textContent = `‚è± Time: ${Math.floor(result.time/60)}:${(result.time%60).toString().padStart(2,'0')} (${result.time}min)`;
  document.getElementById('result-changes').textContent = `üîÑ Changes: ${result.changes}`;
  document.getElementById('result-fare').textContent = `üí∞ Fare: ¬£${result.fare.toFixed(2)}`;
  document.getElementById('result-oyster').textContent = `üÉè Oyster Balance: ¬£${gameState.oyster.toFixed(2)}`;
  document.getElementById('result-pb').textContent = isPB ? 'üèÖ NEW PERSONAL BEST!' : won ? 'üéØ Goal achieved!' : 'üí® Better luck next time!';
  
  const rc = document.getElementById('result-cards');
  rc.innerHTML = wonCards.length > 0 ? wonCards.map(c => renderCardMini(c)).join('') : '<p style="color:var(--text-dim)">No cards this run</p>';
  
  if (won) playSound('ding');
}

function renderCardMini(cardDef) {
  return `<div class="tube-card" style="width:90px;background:linear-gradient(135deg,${cardDef.color}AA,${cardDef.color}44)">
    <div class="card-line" style="color:${cardDef.color}">${lineNames[cardDef.line]?.substring(0,4)||cardDef.line}</div>
    <div class="card-name">${cardDef.name}</div>
    <div class="card-stats">‚ö°${cardDef.stats.speed} üë•${cardDef.stats.crowd}</div>
    <div class="card-ability">${cardDef.ability}</div>
  </div>`;
}

function closeResult() {
  document.getElementById('result-screen').classList.add('hidden');
  updateOysterDisplay();
  updateScoresTab();
  renderCards();
  renderGallery();
}

// ============================================================
// CARDS RENDERING
// ============================================================
function renderCards() {
  const active = gameState.deck.filter(c=>c.active);
  const dg = document.getElementById('deck-grid');
  const cg = document.getElementById('collection-grid');
  
  dg.innerHTML = '';
  cg.innerHTML = '';
  
  gameState.collection.forEach(c => {
    const def = cardDefs.find(d=>d.id===c.id);
    if (!def) return;
    const isActive = c.active;
    const el = document.createElement('div');
    el.className = 'tube-card' + (isActive?' selected':'');
    el.style.background = `linear-gradient(135deg,${def.color}AA,${def.color}33)`;
    el.innerHTML = `
      <div class="card-line" style="color:${def.color}">${lineNames[def.line]?.substring(0,3)||def.line}</div>
      <div class="card-name">${def.name}</div>
      <div class="card-stats">‚ö°${def.stats.speed} üë•${def.stats.crowd}</div>
      <div class="card-ability">${def.ability}</div>
      ${isActive ? '<div style="color:var(--gold);font-size:10px;margin-top:4px">‚òÖ ACTIVE</div>' : ''}
    `;
    el.onclick = () => toggleCard(c, el, active);
    
    if (isActive) dg.appendChild(el.cloneNode(true));
    cg.appendChild(el);
    
    el.onclick = () => toggleCard(c, el, active);
  });
  
  // Re-attach onclick after clone
  dg.querySelectorAll('.tube-card').forEach((el,i) => {
    const card = gameState.collection.filter(c=>c.active)[i];
    if (card) el.onclick = ()=>toggleCard(card, el, active);
  });
}

function toggleCard(card, el, active) {
  if (card.active) {
    card.active = false;
  } else {
    if (active.length >= 5) {
      // Deactivate first active
      const first = gameState.collection.find(c=>c.active);
      if (first) first.active = false;
    }
    card.active = true;
  }
  playSound('chug');
  renderCards();
  saveState();
}

// ============================================================
// SCORES / GALLERY
// ============================================================
function updateScoresTab() {
  const tbody = document.getElementById('pb-tbody');
  const wtbody = document.getElementById('worst-tbody');
  tbody.innerHTML = gameState.pbs.map(p => 
    `<tr><td>${p.route}</td><td>${p.score}</td><td>${p.time}min</td></tr>`
  ).join('') || '<tr><td colspan="3" style="color:var(--text-dim)">No runs yet!</td></tr>';
  
  wtbody.innerHTML = gameState.worsts.map(p => 
    `<tr><td>${p.route}</td><td>${p.score}</td><td>${p.time}min</td></tr>`
  ).join('') || '<tr><td colspan="3" style="color:var(--text-dim)">No runs yet!</td></tr>';
  
  renderMilestonesBadges();
}

const milestonesDefs = [
  {id:'e_expert', name:'Elizabeth Expert', desc:'Win 3 E-line missions', icon:'üü£', check:()=>(gameState.milestones.e_wins||0)>=3},
  {id:'speed_demon', name:'Speed Demon', desc:'Complete in under 10 min', icon:'‚ö°', check:()=>(gameState.milestones.fast_wins||0)>=1},
  {id:'miser', name:'Budget Commuter', desc:'Fare under ¬£3 three times', icon:'üí∏', check:()=>(gameState.milestones.cheap_wins||0)>=3},
  {id:'streak5', name:'5-Day Streak', desc:'Win 5 missions in a row', icon:'üî•', check:()=>gameState.streak>=5},
  {id:'collector', name:'Card Collector', desc:'Collect 10 cards', icon:'üÉè', check:()=>gameState.collection.length>=10},
  {id:'centurion', name:'Centurion', desc:'Score under 100', icon:'üíØ', check:()=>(gameState.milestones.sub100||0)>=1},
];

function checkMilestones() {
  milestonesDefs.forEach(m => {
    if (!gameState.milestones['achieved_'+m.id] && m.check()) {
      gameState.milestones['achieved_'+m.id] = true;
      showEventBrief('üèÖ', `Achievement unlocked: ${m.name}!`);
    }
  });
}

function renderMilestonesBadges() {
  const el = document.getElementById('milestones-area');
  const ml = document.getElementById('milestone-list');
  const achieved = milestonesDefs.filter(m=>gameState.milestones['achieved_'+m.id]);
  
  if (el) el.innerHTML = achieved.map(m => 
    `<div class="milestone-badge">${m.icon} ${m.name}</div>`
  ).join('');
  
  if (ml) ml.innerHTML = milestonesDefs.map(m => {
    const done = gameState.milestones['achieved_'+m.id];
    return `<div class="milestone-badge" style="${done?'':'background:var(--surface2);color:var(--text-dim)'}">
      ${m.icon} ${m.name} ${done?'‚úì':'üîí'} <span style="font-weight:normal;font-size:12px">${m.desc}</span>
    </div>`;
  }).join('');
}

function renderGallery() {
  const gg = document.getElementById('gallery-grid');
  const gc = document.getElementById('gallery-count');
  const gp = document.getElementById('gallery-progress');
  
  const owned = gameState.collection.length;
  const total = cardDefs.length;
  
  if (gc) gc.textContent = owned;
  if (gp) gp.style.width = `${(owned/total)*100}%`;
  
  if (!gg) return;
  gg.innerHTML = '';
  
  cardDefs.forEach(def => {
    const has = gameState.collection.some(c=>c.id===def.id);
    const el = document.createElement('div');
    if (has) {
      el.className = 'tube-card';
      el.style.background = `linear-gradient(135deg,${def.color}AA,${def.color}33)`;
      el.innerHTML = `<div class="card-line" style="color:${def.color}">${lineNames[def.line]?.substring(0,3)||def.line}</div>
        <div class="card-name" style="font-size:9px">${def.name}</div>
        <div class="card-stats">‚ö°${def.stats.speed}</div>`;
    } else {
      el.className = 'gallery-slot';
      el.innerHTML = '?';
      el.title = 'Not yet collected';
    }
    gg.appendChild(el);
  });
}

function renderMarket() {
  const ma = document.getElementById('market-area');
  if (!ma) return;
  
  const available = cardDefs.filter(c => !gameState.collection.some(gc=>gc.id===c.id));
  const forSale = available.slice(0,5);
  
  if (forSale.length === 0) {
    ma.innerHTML = '<p style="color:var(--text-dim)">You have all available cards!</p>';
    return;
  }
  
  ma.innerHTML = forSale.map(c => `
    <div class="market-card" onclick="buyCard('${c.id}')">
      <div style="width:40px;height:50px;border-radius:8px;background:${c.color};display:flex;align-items:center;justify-content:center;font-size:18px">
        ${lineNames[c.line]?.substring(0,1)||'?'}
      </div>
      <div class="market-card-info">
        <h4>${c.name}</h4>
        <p>Line ${c.line} ¬∑ ${c.ability}</p>
      </div>
      <div class="market-price">¬£${(8 + cardDefs.indexOf(c)%5).toFixed(0)}</div>
    </div>
  `).join('');
}

function buyCard(id) {
  const def = cardDefs.find(d=>d.id===id);
  if (!def) return;
  const price = 8 + cardDefs.indexOf(def)%5;
  if (gameState.oyster < price) {
    showEventBrief('üí∏', `Need ¬£${price} to buy this card!`);
    return;
  }
  gameState.oyster -= price;
  addCard(id);
  updateOysterDisplay();
  renderCards();
  renderGallery();
  renderMarket();
  saveState();
  playSound('cha');
  showEventBrief('üÉè', `Bought ${def.name}!`);
}

// ============================================================
// SHARE
// ============================================================
function shareChallenge() {
  if (!missionState.start) {
    showEventBrief('‚ö†Ô∏è','Spin a mission first!');
    return;
  }
  const seed = `${missionState.start}-${missionState.end}-${missionState.goal.type}`;
  const url = `${window.location.href.split('?')[0]}?seed=${btoa(seed)}`;
  const sc = document.getElementById('share-code');
  sc.style.display = 'block';
  sc.innerHTML = `<div style="background:var(--surface2);border-radius:10px;padding:8px;font-size:12px;word-break:break-all;margin-bottom:6px">${url}</div>
    <button class="btn-small btn-secondary" onclick="navigator.clipboard.writeText('${url}').then(()=>showEventBrief('üìã','Copied!'))">
      üìã Copy Link
    </button>`;
}

function shareResult() {
  const text = `üöá Tube Quest Score: ${document.getElementById('result-score').textContent}\n${document.getElementById('result-time').textContent}\n${document.getElementById('result-fare').textContent}\nüî• Streak: ${gameState.streak}\nPlay at: ${window.location.href}`;
  if (navigator.share) {
    navigator.share({title:'Tube Quest', text}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text).then(()=>showEventBrief('üìã','Result copied!')).catch(()=>{});
  }
}

// ============================================================
// UI HELPERS
// ============================================================
function updateOysterDisplay() {
  document.getElementById('oyster-display').textContent = `üÉè ¬£${gameState.oyster.toFixed(2)}`;
  document.getElementById('streak-display').textContent = `üî• ${gameState.streak}`;
  
  // Low balance warning
  if (gameState.oyster < 5) {
    document.getElementById('oyster-display').style.background = 'var(--tfl-red)';
    document.getElementById('oyster-display').style.color = '#fff';
  } else {
    document.getElementById('oyster-display').style.background = 'var(--oyster-teal)';
    document.getElementById('oyster-display').style.color = '#000';
  }
  
  // Auto top-up if broke
  if (gameState.oyster < 3) {
    gameState.oyster += 20;
    showEventBrief('üí≥', 'Auto top-up! +¬£20 on your Oyster');
    updateOysterDisplay();
    saveState();
  }
}

function showTab(name) {
  ['game','cards','scores','gallery'].forEach(t => {
    document.getElementById(`tab-content-${t}`).style.display = t===name?'block':'none';
    document.getElementById(`tab-${t}`).classList.toggle('active', t===name);
  });
  if (name==='cards') renderCards();
  if (name==='scores') updateScoresTab();
  if (name==='gallery') { renderGallery(); renderMarket(); }
}

function closeTutorial() {
  document.getElementById('modal-overlay').classList.add('hidden');
  gameState.tutorialSeen = true;
  saveState();
}

// ============================================================
// CONTROLS
// ============================================================
document.getElementById('btn-mute').addEventListener('click', () => {
  gameState.muted = !gameState.muted;
  document.getElementById('btn-mute').textContent = gameState.muted ? 'üîá' : 'üîä';
  saveState();
});

document.getElementById('btn-slow').addEventListener('click', () => {
  gameState.slowMode = !gameState.slowMode;
  document.getElementById('btn-slow').style.background = gameState.slowMode ? 'var(--oyster-teal)' : 'var(--surface2)';
  document.getElementById('btn-slow').style.color = gameState.slowMode ? '#000' : 'var(--text)';
  showEventBrief(gameState.slowMode?'üê¢':'üêá', gameState.slowMode?'Slow Mode ON - timers doubled':'Slow Mode OFF');
  saveState();
});

document.getElementById('btn-fullscreen').addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(()=>{});
    document.getElementById('btn-fullscreen').textContent = '‚õ∂';
  } else {
    document.exitFullscreen().catch(()=>{});
    document.getElementById('btn-fullscreen').textContent = '‚õ∂';
  }
});

// URL seed
function checkURLSeed() {
  const params = new URLSearchParams(window.location.search);
  const seed = params.get('seed');
  if (seed) {
    try {
      const decoded = atob(seed);
      const [start, end, goalType] = decoded.split('-');
      if (stations[start] && stations[end]) {
        missionState.start = start;
        missionState.end = end;
        missionState.goal = missionGoals.find(g=>g.type===goalType) || missionGoals[0];
        missionState.active = true;
        missionState.playerPath = [start];
        gameState.oyster -= 20;
        updateMissionCard();
        updateMap();
        updateBuildSection();
        document.getElementById('phase-banner').textContent = 'üó∫Ô∏è BUILD YOUR ROUTE (Challenge!)';
        document.getElementById('build-section-map').style.display = 'block';
        showEventBrief('üéØ','Friend\'s challenge loaded! Build your route!');
        updateOysterDisplay();
      }
    } catch(e) {}
  }
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', () => {
  loadState();
  buildGraph();
  buildMap();
  updateOysterDisplay();
  renderCards();
  updateScoresTab();
  renderGallery();
  
  // Restore UI state
  if (gameState.muted) document.getElementById('btn-mute').textContent = 'üîá';
  if (gameState.slowMode) {
    document.getElementById('btn-slow').style.background = 'var(--oyster-teal)';
    document.getElementById('btn-slow').style.color = '#000';
  }
  
  checkURLSeed();
  
  setTimeout(() => {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    if (!gameState.tutorialSeen) {
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
  }, 1200);
});
</script>
</body>
</html>
